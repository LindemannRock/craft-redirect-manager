{% extends "_layouts/cp" %}
{% set title = "Statistics"|t('redirect-manager') %}
{% set selectedSubnavItem = 'statistics' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set crumbs = [
    {
        label: plugin.settings.pluginName|t('redirect-manager'),
        url: url('redirect-manager'),
    },
    {
        label: 'Statistics'|t('redirect-manager'),
        url: url('redirect-manager/statistics'),
    },
] %}

{% block content %}
    <div id="analytics-dashboard">
        <div class="analytics-stats">
            <div class="stat-box">
                <div class="stat-value" id="total-404s">{{ totalCount ?? 0 }}</div>
                <div class="stat-label">{{ "Total 404s"|t('redirect-manager') }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="handled-404s">{{ handledCount ?? 0 }}</div>
                <div class="stat-label">{{ "Handled"|t('redirect-manager') }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="unhandled-404s">{{ unhandledCount ?? 0 }}</div>
                <div class="stat-label">{{ "Unhandled"|t('redirect-manager') }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="success-rate">{{ totalCount > 0 ? ((handledCount / totalCount * 100)|round) : 0 }}%</div>
                <div class="stat-label">{{ "Success Rate"|t('redirect-manager') }}</div>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "404 Trend (Last 30 Days)"|t('redirect-manager') }}</h2>

        <div class="analytics-charts">
            <div class="chart-container full-width">
                <canvas id="404-trend-chart"></canvas>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Most Common 404s"|t('redirect-manager') }}</h2>

        <div class="analytics-charts">
            <div class="chart-container full-width">
                <div class="table-scroll-container">
                    <table class="data fullwidth">
                        <thead>
                            <tr>
                                <th>{{ 'URL'|t('redirect-manager') }}</th>
                                <th>{{ 'Count'|t('redirect-manager') }}</th>
                                <th>{{ 'Handled'|t('redirect-manager') }}</th>
                                <th>{{ 'Last Hit'|t('redirect-manager') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in mostCommon %}
                                <tr>
                                    <td>
                                        <a class="label-link" href="{{ stat.url }}" target="_blank">
                                            <span><code>{{ stat.url|slice(0, 80) }}</code></span>
                                        </a>
                                    </td>
                                    <td><strong>{{ stat.count }}</strong></td>
                                    <td>
                                        {% if stat.handled %}
                                            <span class="status green"></span>
                                        {% else %}
                                            <span class="status red"></span>
                                        {% endif %}
                                    </td>
                                    <td>{{ stat.lastHit|date('Y-m-d H:i:s') }}</td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="4" class="thin light">{{ "No 404s recorded yet"|t('redirect-manager') }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Recent Unhandled 404s"|t('redirect-manager') }}</h2>

        <div class="analytics-charts">
            <div class="chart-container full-width">
                <div class="table-scroll-container">
                    <table class="data fullwidth">
                        <thead>
                            <tr>
                                <th>{{ 'URL'|t('redirect-manager') }}</th>
                                <th>{{ 'Count'|t('redirect-manager') }}</th>
                                <th>{{ 'Referrer'|t('redirect-manager') }}</th>
                                <th>{{ 'Last Hit'|t('redirect-manager') }}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in recentUnhandled %}
                                <tr>
                                    <td>
                                        <a class="label-link" href="{{ stat.url }}" target="_blank">
                                            <span><code>{{ stat.url|slice(0, 80) }}</code></span>
                                        </a>
                                    </td>
                                    <td>{{ stat.count }}</td>
                                    <td>{{ stat.referrer ? stat.referrer|slice(0, 40) : '-' }}</td>
                                    <td>{{ stat.lastHit|date('Y-m-d H:i:s') }}</td>
                                    <td>
                                        <a href="{{ url('redirect-manager/redirects/new', { sourceUrl: stat.url }) }}"
                                           class="btn submit icon add"
                                           title="{{ 'Create redirect'|t('redirect-manager') }}"></a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="thin light">{{ "No unhandled 404s! Great job!"|t('redirect-manager') }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% include 'redirect-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% css %}
    #analytics-dashboard {
        padding: 24px;
    }

    .analytics-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-box {
        background: #f3f7fc;
        padding: 24px;
        border-radius: 4px;
        text-align: center;
        border: 1px solid var(--border-hairline);
    }

    .stat-value {
        font-size: 32px;
        font-weight: 600;
        color: #0d78f2;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: #596673;
    }

    .analytics-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }

    .chart-container.full-width {
        grid-column: 1 / -1;
    }

    .chart-container {
        background: #fff;
        border: 1px solid #e3e5e8;
        border-radius: 4px;
        padding: 24px;
    }

    .chart-container canvas {
        max-height: 300px;
    }

    .table-scroll-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -24px;
        padding: 0 24px;
    }

    .table-scroll-container table {
        min-width: 600px;
    }
{% endcss %}

{% js %}
    // Load Chart.js if not already loaded
    if (typeof Chart === 'undefined') {
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
        script.onload = initCharts;
        document.head.appendChild(script);
    } else {
        initCharts();
    }

    function initCharts() {
        // Prepare chart data
        const chartData = {{ chartData|json_encode|raw }};

        if (chartData && chartData.length > 0) {
            // 404 Trend Chart
            new Chart(document.getElementById('404-trend-chart'), {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [
                        {
                            label: '{{ "Handled"|t('redirect-manager') }}',
                            data: chartData.map(d => d.handled),
                            borderColor: '#10B981',
                            backgroundColor: '#10B981',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '{{ "Unhandled"|t('redirect-manager') }}',
                            data: chartData.map(d => d.unhandled),
                            borderColor: '#EF4444',
                            backgroundColor: '#EF4444',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            align: 'center',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }
    }
{% endjs %}
