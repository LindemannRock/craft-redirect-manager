{% extends "_layouts/cp" %}
{% set title = "Import/Export"|t('redirect-manager') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'import-export' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set crumbs = [
    { label: redirectHelper.fullName|t('redirect-manager'),url: url('redirect-manager'),},
    { label: 'Import/Export'|t('redirect-manager'), url: url('redirect-manager/import-export') }

] %}

{% set tabs = {} %}
{% if canImport or canExport %}
    {% set tabs = tabs|merge({
        importExport: {
            label: 'Import/Export'|t('redirect-manager'),
            url: '#import-export',
        },
    }) %}
{% endif %}
{% if canImport %}
    {% set tabs = tabs|merge({
        importHistory: {
            label: 'Import History'|t('redirect-manager'),
            url: '#import-history',
        },
    }) %}
{% endif %}

{% import "_includes/forms" as forms %}

{% set canCreateBackup = currentUser.can('redirectManager:manageBackups') or currentUser.can('redirectManager:createBackups') %}

{% set maxRows = importLimits.maxRows ?? 4000 %}
{% set maxBytes = importLimits.maxBytes ?? 5242880 %}
{% set maxSize = craft.app.formatter.asShortSize(maxBytes, 2) %}

{% block content %}
	<div id="import-export">
		<h2 style="margin-top: 0px;">{{ "Export Redirects"|t('redirect-manager') }}</h2>

		{% if canExport %}
			<p>{{ "Download all your current redirects as a CSV file for backup or migration to another site."|t('redirect-manager') }}</p>

			<form method="post" action="{{ actionUrl('redirect-manager/import-export/export') }}" style="margin-bottom: 50px;">
				{{ csrfInput() }}

				<button type="submit" class="btn secondary">
					{{ "Export All Redirects as CSV"|t('redirect-manager') }}
				</button>
			</form>
		{% else %}
			<p class="light">{{ "You do not have permission to export redirects."|t('redirect-manager') }}</p>
		{% endif %}

		<hr>

		<h2>{{ "Import Redirects"|t('redirect-manager') }}</h2>

		{% set csvFormatTip %}
		<h4>{{ "CSV Format"|t('redirect-manager') }}</h4>
		<p>
			<strong>{{ "Required columns:"|t('redirect-manager') }}</strong>
		</p>
		<ul>
			<li>{{ "sourceUrl"|t('redirect-manager') }}
				-
				{{ "The URL to redirect from"|t('redirect-manager') }}</li>
			<li>{{ "destinationUrl"|t('redirect-manager') }}
				-
				{{ "The URL to redirect to"|t('redirect-manager') }}</li>
		</ul>
		<p>
			<strong>{{ "Optional columns:"|t('redirect-manager') }}</strong>
		</p>
		<ul>
			<li>{{ "statusCode"|t('redirect-manager') }}
				-
				{{ "HTTP status (301, 302, etc.)"|t('redirect-manager') }}</li>
			<li>{{ "matchType"|t('redirect-manager') }}
				-
				{{ "exact, regex, wildcard, or prefix"|t('redirect-manager') }}</li>
			<li>{{ "redirectSrcMatch"|t('redirect-manager') }}
				-
				{{ "pathonly or fullurl (default: pathonly)"|t('redirect-manager') }}</li>
			<li>{{ "siteId"|t('redirect-manager') }}
				-
				{{ "Site ID (blank = all sites)"|t('redirect-manager') }}</li>
			<li>{{ "priority"|t('redirect-manager') }}
				-
				{{ "0-9 (default: 0)"|t('redirect-manager') }}</li>
			<li>{{ "enabled"|t('redirect-manager') }}
				-
				{{ "1 or 0 (default: 1)"|t('redirect-manager') }}</li>
		</ul>
		<p>
			<strong>{{ "Example:"|t('redirect-manager') }}</strong>
		</p>
		<pre style="background: #f3f4f6; padding: 8px; border-radius: 4px; font-size: 12px;">sourceUrl,destinationUrl,statusCode,matchType
"/old-page","/new-page","301","exact"
"/blog/*","/articles/*","301","wildcard"
"^/legacy-(.*)","$1","301","regex"</pre>
		{% endset %}

		{% if canImport %}
		{% include 'lindemannrock-base/_partials/import-csv' with {
			action: actionUrl('redirect-manager/import-export/upload'),
			formId: 'uploadForm',
			title: 'Import from CSV'|t('redirect-manager'),
			description: "Import redirects from a CSV file. You'll be able to map columns and preview before importing."|t('redirect-manager'),
			csvFormatTip: csvFormatTip,
			fileLabel: 'CSV File'|t('redirect-manager'),
			fileInstructions: 'Select a CSV file to import redirects'|t('redirect-manager'),
			delimiterLabel: 'CSV Delimiter'|t('redirect-manager'),
			delimiterInstructions: 'Character used to separate values in your CSV (auto-detect is default)'|t('redirect-manager'),
			delimiterValue: 'auto',
			delimiterOptions: {
				'auto': 'Auto (detect)'|t('redirect-manager'),
				',': 'Comma (,)'|t('redirect-manager'),
				';': 'Semicolon (;)'|t('redirect-manager'),
				"\t": 'Tab'|t('redirect-manager'),
				'|': 'Pipe (|)'|t('redirect-manager'),
			},
			showBackupToggle: canCreateBackup,
			backupLabel: 'Create Backup Before Import'|t('redirect-manager'),
			backupInstructions: 'Automatically backup existing redirects before importing (recommended)'|t('redirect-manager'),
			backupEnabled: settings.backupEnabled,
			backupOnImport: settings.backupOnImport,
			backupWarning: 'Backups are disabled in settings.'|t('redirect-manager'),
			infoBoxMessage: 'The maximum file size is {size} and the import is limited to {rows} rows per file.'|t('redirect-manager', {
				size: maxSize,
				rows: maxRows|number_format
			}),
			submitLabel: 'Upload & Map Columns'|t('redirect-manager'),
		} %}
		{% else %}
			<p class="light">{{ "You do not have permission to import redirects."|t('redirect-manager') }}</p>
		{% endif %}
	</div>

	{% if canImport %}
	<div id="import-history" class="hidden">
		<h2>{{ "Import History"|t('redirect-manager') }}</h2>
		<p>{{ "Recent CSV imports and their results."|t('redirect-manager') }}</p>

		{% if importHistory|length > 0 %}
			<table class="data fullwidth">
				<thead>
					<tr>
						<th>{{ "Date"|t('redirect-manager') }}</th>
						<th>{{ "Created By"|t('redirect-manager') }}</th>
						<th>{{ "Filename"|t('redirect-manager') }}</th>
						<th>{{ "Size"|t('redirect-manager') }}</th>
						<th>{{ "Imported"|t('redirect-manager') }}</th>
						<th>{{ "Failed"|t('redirect-manager') }}</th>
						<th>{{ "Backup"|t('redirect-manager') }}</th>
					</tr>
				</thead>
				<tbody>
					{% for item in importHistory %}
						<tr>
							<td>{{ item.date|datetime('short') }}</td>
							<td>{{ item.user }}</td>
							<td>{{ item.filename ?? '-' }}</td>
							<td><code style="font-size: 11px;">{{ item.formattedSize }}</code></td>
							<td><strong>{{ item.imported }}</strong></td>
							<td>{{ item.failed }}</td>
							<td>
								{% if item.backupPath %}
									<a href="{{ url('redirect-manager/backups') }}" class="go">{{ item.backupPath }}</a>
								{% else %}
									-
								{% endif %}
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
	{% else %}
			<p class="light" style="text-align: center; padding: 40px;">{{ "No import history yet."|t('redirect-manager') }}</p>
	{% endif %}
	</div>
	{% endif %}

	{% include 'lindemannrock-base/_components/plugin-credit' %}

{% endblock %}

{% js %}
    // Initialize menu buttons
    document.querySelectorAll('.menubtn').forEach(btn => {
        if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
            new Craft.MenuBtn(btn);
        } else if (typeof Garnish !== 'undefined' && Garnish.MenuBtn) {
            new Garnish.MenuBtn(btn);
        }
    });
{% endjs %}
