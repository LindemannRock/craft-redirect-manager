{% extends "_layouts/cp" %}
{% set title = "Preview Import"|t('redirect-manager') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'import-export' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set crumbs = [
    {
        label: plugin.settings.pluginName|t('redirect-manager'),
        url: url('redirect-manager'),
    },
    {
        label: 'Import/Export'|t('redirect-manager'),
        url: url('redirect-manager/import-export'),
    },
    {
        label: 'Preview'|t('redirect-manager'),
    },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
    <h2 style="margin-top: 0px;">{{ "Import Preview"|t('redirect-manager') }}</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 30px 0;">
        <div style="background: #f7f7f7; padding: 20px; border-radius: 4px; text-align: center; border: 1px solid #e0e0e0;">
            <div style="font-size: 32px; font-weight: bold; color: #333;">{{ summary.totalRows }}</div>
            <div style="color: #666; margin-top: 5px;">{{ "Total Rows"|t('redirect-manager') }}</div>
        </div>
        <div style="background: #e8f5e9; padding: 20px; border-radius: 4px; text-align: center; border: 1px solid #a5d6a7;">
            <div style="font-size: 32px; font-weight: bold; color: #28a745;">{{ summary.validRows }}</div>
            <div style="color: #666; margin-top: 5px;">{{ "Valid"|t('redirect-manager') }}</div>
        </div>
        <div style="background: #fff3cd; padding: 20px; border-radius: 4px; text-align: center; border: 1px solid #ffd966;">
            <div style="font-size: 32px; font-weight: bold; color: #f59e0b;">{{ summary.duplicates }}</div>
            <div style="color: #666; margin-top: 5px;">{{ "Duplicates"|t('redirect-manager') }}</div>
        </div>
        <div style="background: #f8d7da; padding: 20px; border-radius: 4px; text-align: center; border: 1px solid #f5c2c7;">
            <div style="font-size: 32px; font-weight: bold; color: #dc3545;">{{ summary.errors }}</div>
            <div style="color: #666; margin-top: 5px;">{{ "Errors"|t('redirect-manager') }}</div>
        </div>
    </div>

    {% if createBackup and existingCount > 0 %}
        <div style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin-bottom: 25px; border: 1px solid #a5d6a7;">
            <p style="margin: 0; display: flex; align-items: center; gap: 10px;">
                <svg width="20" height="20" viewBox="0 0 20 20" style="flex-shrink: 0;">
                    <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z" fill="#28a745"/>
                </svg>
                <strong>{{ "Backup will be created with {count} existing redirect(s) before importing to protect your data."|t('redirect-manager', {count: existingCount}) }}</strong>
            </p>
        </div>
    {% endif %}

    {% if validRows|length > 0 %}
        <hr>
        <h3>{{ "Valid Redirects to Import"|t('redirect-manager') }} ({{ validRows|length }})</h3>
        <div style="max-height: 500px; overflow: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
            <table class="data fullwidth" style="margin: 0;">
                <thead style="position: sticky; top: 0; background: #f7f7f7; z-index: 1;">
                    <tr>
                        <th>{{ "Source URL"|t('redirect-manager') }}</th>
                        <th>{{ "Destination URL"|t('redirect-manager') }}</th>
                        <th>{{ "Site"|t('redirect-manager') }}</th>
                        <th>{{ "Match Type"|t('redirect-manager') }}</th>
                        <th>{{ "Source Match"|t('redirect-manager') }}</th>
                        <th>{{ "Status"|t('redirect-manager') }}</th>
                        <th>{{ "Priority"|t('redirect-manager') }}</th>
                        <th>{{ "Enabled"|t('redirect-manager') }}</th>
                        <th>{{ "Hits"|t('redirect-manager') }}</th>
                        <th>{{ "Last Hit"|t('redirect-manager') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in validRows %}
                        <tr>
                            <td><code style="font-size: 11px;">{{ row.sourceUrl }}</code></td>
                            <td><code style="font-size: 11px;">{{ row.destinationUrl }}</code></td>
                            <td style="white-space: nowrap;">
                                {% if row.siteId %}
                                    {% set site = craft.app.sites.getSiteById(row.siteId) %}
                                    {{ site ? site.name : row.siteId }}
                                {% else %}
                                    <span class="light">All sites</span>
                                {% endif %}
                            </td>
                            <td>{{ row.matchType }}</td>
                            <td>{{ row.redirectSrcMatch }}</td>
                            <td>{{ row.statusCode }}</td>
                            <td>{{ row.priority }}</td>
                            <td>{{ row.enabled ? 'Yes' : 'No' }}</td>
                            <td>{{ row.hitCount ?? 0 }}</td>
                            <td style="white-space: nowrap; font-size: 11px;">{{ row.lastHit ? row.lastHit : '-' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    {% if duplicateRows|length > 0 %}
        <hr>
        <h3>{{ "Duplicate Redirects (will be skipped)"|t('redirect-manager') }} ({{ duplicateRows|length }})</h3>
        <p class="light">{{ "These redirects already exist with the same source URL, match type, and source match mode."|t('redirect-manager') }}</p>
        <div style="max-height: 300px; overflow: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
            <table class="data fullwidth" style="margin: 0;">
                <thead style="position: sticky; top: 0; background: #fffbf0; z-index: 1;">
                    <tr>
                        <th>{{ "Source URL"|t('redirect-manager') }}</th>
                        <th>{{ "Destination URL"|t('redirect-manager') }}</th>
                        <th>{{ "Reason"|t('redirect-manager') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in duplicateRows %}
                        <tr>
                            <td><code style="font-size: 11px;">{{ row.sourceUrl }}</code></td>
                            <td><code style="font-size: 11px;">{{ row.destinationUrl }}</code></td>
                            <td class="light">{{ row.reason }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    {% if errorRows|length > 0 %}
        <hr>
        <h3>{{ "Invalid Rows (will be skipped)"|t('redirect-manager') }} ({{ errorRows|length }})</h3>
        <div style="max-height: 300px; overflow: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
            <table class="data fullwidth" style="margin: 0;">
                <thead style="position: sticky; top: 0; background: #fef2f2; z-index: 1;">
                    <tr>
                        <th style="width: 80px;">{{ "Row #"|t('redirect-manager') }}</th>
                        <th>{{ "Data"|t('redirect-manager') }}</th>
                        <th>{{ "Error"|t('redirect-manager') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in errorRows %}
                        <tr>
                            <td>{{ row.rowNumber }}</td>
                            <td><code style="font-size: 11px;">{{ row.data|slice(0, 100) }}</code></td>
                            <td style="color: #dc3545;">{{ row.error }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    <hr>

    <form method="post" action="{{ actionUrl('redirect-manager/import-export/import') }}" id="importForm">
        {{ csrfInput() }}

        <div style="background: #f7f7f7; padding: 20px; border-radius: 4px; margin: 20px 0;">
            <h3 style="margin-top: 0;">{{ "Ready to Import"|t('redirect-manager') }}</h3>
            <p>
                {% if summary.validRows > 0 %}
                    {{ "Click the button below to import {count} valid redirect(s)."|t('redirect-manager', {count: summary.validRows}) }}
                    {% if summary.duplicates > 0 %}
                        {{ "{duplicates} duplicate(s) will be skipped."|t('redirect-manager', {duplicates: summary.duplicates}) }}
                    {% endif %}
                    {% if summary.errors > 0 %}
                        {{ "{errors} invalid row(s) will be skipped."|t('redirect-manager', {errors: summary.errors}) }}
                    {% endif %}
                {% else %}
                    {{ "No valid redirects found to import."|t('redirect-manager') }}
                {% endif %}
            </p>

            <div class="buttons" style="margin-top: 15px;">
                <a href="{{ url('redirect-manager/import-export') }}" class="btn secondary">{{ "Cancel"|t('redirect-manager') }}</a>
                {% if summary.validRows > 0 %}
                    <button type="submit" class="btn submit">
                        {{ "Import {count} Redirects"|t('redirect-manager', {count: summary.validRows}) }}
                    </button>
                {% else %}
                    <button type="button" class="btn disabled" disabled>
                        {{ "No Valid Redirects to Import"|t('redirect-manager') }}
                    </button>
                {% endif %}
            </div>
        </div>
    </form>

    {% include 'redirect-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% js %}
    // Confirm before importing
    const importForm = document.getElementById('importForm');
    if (importForm) {
        importForm.addEventListener('submit', function(e) {
            const count = {{ summary.validRows }};
            if (!confirm('Import ' + count + ' redirect(s)? {% if createBackup %}A backup will be created first.{% endif %}')) {
                e.preventDefault();
                return false;
            }
        });
    }
{% endjs %}
