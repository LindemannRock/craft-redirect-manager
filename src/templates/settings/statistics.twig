{% extends "redirect-manager/_layouts/settings" %}
{% set title = "Statistics Settings"|t('redirect-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'statistics' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set crumbs = [
    {
        label: plugin.settings.pluginName|t('redirect-manager'),
        url: url('redirect-manager'),
    },
    {
        label: 'Settings'|t('redirect-manager'),
        url: url('redirect-manager/settings'),
    },
    {
        label: 'Statistics'|t('redirect-manager'),
        url: url('redirect-manager/settings/statistics'),
    },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
    <form method="post" accept-charset="UTF-8">
        {{ actionInput('redirect-manager/settings/save') }}
        {{ csrfInput() }}
        {{ redirectInput('redirect-manager/settings/statistics') }}

        <h2 style="margin-top: 0px;">{{ "Statistics Settings"|t('redirect-manager') }}</h2>

        {{ forms.lightswitchField({
            label: 'Record Remote IP'|t('redirect-manager'),
            instructions: 'Record anonymized IP addresses for 404s (privacy-safe - last octet hidden)'|t('redirect-manager'),
            id: 'recordRemoteIp',
            name: 'settings[recordRemoteIp]',
            on: settings.recordRemoteIp,
            disabled: settings.isOverriddenByConfig('recordRemoteIp'),
            warning: settings.isOverriddenByConfig('recordRemoteIp') ?
                "This is being overridden by the <code>recordRemoteIp</code> setting in <code>config/redirect-manager.php</code>."|t('redirect-manager')|raw : null,
        }) }}

        {{ forms.lightswitchField({
            label: 'Strip Query String From Stats'|t('redirect-manager'),
            instructions: 'Strip query strings from statistics URLs to consolidate similar requests'|t('redirect-manager'),
            id: 'stripQueryStringFromStats',
            name: 'settings[stripQueryStringFromStats]',
            on: settings.stripQueryStringFromStats,
            disabled: settings.isOverriddenByConfig('stripQueryStringFromStats'),
            warning: settings.isOverriddenByConfig('stripQueryStringFromStats') ?
                "This is being overridden by the <code>stripQueryStringFromStats</code> setting in <code>config/redirect-manager.php</code>."|t('redirect-manager')|raw : null,
        }) }}

        <hr>

        <h2>{{ "Statistics Limits"|t('redirect-manager') }}</h2>

        {{ forms.textField({
            label: 'Statistics Limit'|t('redirect-manager'),
            instructions: 'Maximum number of unique 404 records to retain'|t('redirect-manager'),
            id: 'statisticsLimit',
            name: 'settings[statisticsLimit]',
            type: 'number',
            value: settings.statisticsLimit,
            required: true,
            disabled: settings.isOverriddenByConfig('statisticsLimit'),
            warning: settings.isOverriddenByConfig('statisticsLimit') ?
                "This is being overridden by the <code>statisticsLimit</code> setting in <code>config/redirect-manager.php</code>."|t('redirect-manager')|raw : null,
        }) }}

        {{ forms.textField({
            label: 'Statistics Retention (Days)'|t('redirect-manager'),
            instructions: 'Number of days to retain statistics (0 = keep forever)'|t('redirect-manager'),
            id: 'statisticsRetention',
            name: 'settings[statisticsRetention]',
            type: 'number',
            value: settings.statisticsRetention,
            required: true,
            disabled: settings.isOverriddenByConfig('statisticsRetention'),
            warning: settings.isOverriddenByConfig('statisticsRetention') ?
                "This is being overridden by the <code>statisticsRetention</code> setting in <code>config/redirect-manager.php</code>."|t('redirect-manager')|raw : null,
        }) }}

        {{ forms.lightswitchField({
            label: 'Auto Trim Statistics'|t('redirect-manager'),
            instructions: 'Automatically trim statistics to respect the limit'|t('redirect-manager'),
            id: 'autoTrimStatistics',
            name: 'settings[autoTrimStatistics]',
            on: settings.autoTrimStatistics,
            disabled: settings.isOverriddenByConfig('autoTrimStatistics'),
            warning: settings.isOverriddenByConfig('autoTrimStatistics') ?
                "This is being overridden by the <code>autoTrimStatistics</code> setting in <code>config/redirect-manager.php</code>."|t('redirect-manager')|raw : null,
        }) }}

        <hr>

        <h2>{{ "Display Settings"|t('redirect-manager') }}</h2>

        {{ forms.textField({
            label: 'Items Per Page'|t('redirect-manager'),
            instructions: 'Number of items to display per page in lists'|t('redirect-manager'),
            id: 'itemsPerPage',
            name: 'settings[itemsPerPage]',
            type: 'number',
            value: settings.itemsPerPage,
            required: true,
            disabled: settings.isOverriddenByConfig('itemsPerPage'),
            warning: settings.isOverriddenByConfig('itemsPerPage') ?
                "This is being overridden by the <code>itemsPerPage</code> setting in <code>config/redirect-manager.php</code>."|t('redirect-manager')|raw : null,
        }) }}

        {{ forms.selectField({
            label: 'Dashboard Refresh Interval'|t('redirect-manager'),
            instructions: 'How often to refresh dashboard data'|t('redirect-manager'),
            id: 'refreshIntervalSecs',
            name: 'settings[refreshIntervalSecs]',
            value: settings.refreshIntervalSecs,
            required: true,
            options: {
                5: '5 seconds'|t('redirect-manager'),
                15: '15 seconds'|t('redirect-manager'),
                30: '30 seconds'|t('redirect-manager'),
                60: '60 seconds (1 minute)'|t('redirect-manager'),
            },
            disabled: settings.isOverriddenByConfig('refreshIntervalSecs'),
            warning: settings.isOverriddenByConfig('refreshIntervalSecs') ?
                "This is being overridden by the <code>refreshIntervalSecs</code> setting in <code>config/redirect-manager.php</code>."|t('redirect-manager')|raw : null,
        }) }}

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save Settings"|t('redirect-manager') }}</button>
        </div>
    </form>

    {% include 'redirect-manager/_components/plugin-credit.twig' %}
{% endblock %}
