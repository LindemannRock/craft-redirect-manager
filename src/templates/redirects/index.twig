{#
 # Redirects Listing Page
 #
 # Uses the base plugin's cp-table layout for consistent styling.
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set settings = plugin.settings %}

{# Permission checks #}
{% set canCreate = currentUser.can('redirectManager:createRedirects') %}
{% set canEdit = currentUser.can('redirectManager:editRedirects') %}
{% set canDelete = currentUser.can('redirectManager:deleteRedirects') %}
{% set canImportExport = currentUser.can('redirectManager:manageImportExport') %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set matchTypeFilter = craft.app.request.getParam('matchType', 'all') %}
{% set creationTypeFilter = craft.app.request.getParam('creationType', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'dateCreated') %}
{% set dir = craft.app.request.getParam('dir', 'desc') %}

{% set tableConfig = {
    plugin: {
        handle: 'redirect-manager',
        name: redirectHelper.fullName,
    },
    page: {
        title: redirectHelper.pluralDisplayName|t('redirect-manager'),
        subnav: 'redirects',
        crumbs: [
            { label: redirectHelper.fullName, url: url('redirect-manager') },
            { label: 'Redirects'|t('redirect-manager'), url: url('redirect-manager/redirects') },
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: statusFilter == 'all' ? 'All'|t('redirect-manager') : statusFilter|capitalize,
            groups: [
                {
                    param: 'status',
                    current: statusFilter,
                    options: [
                        {value: 'all', label: 'All'|t('redirect-manager'), status: 'all'},
                        {value: 'enabled', label: 'Enabled'|t('redirect-manager'), status: 'green'},
                        {value: 'disabled', label: 'Disabled'|t('redirect-manager'), status: 'disabled'},
                    ],
                },
                {
                    header: 'Match Type'|t('redirect-manager'),
                    param: 'matchType',
                    current: matchTypeFilter,
                    colorSet: 'matchType',
                    options: [
                        {value: 'all', label: 'All Types'|t('redirect-manager'), status: 'all'},
                        {value: 'exact', label: 'Exact Match'|t('redirect-manager'), colorKey: 'exact'},
                        {value: 'regex', label: 'RegEx Match'|t('redirect-manager'), colorKey: 'regex'},
                        {value: 'wildcard', label: 'Wildcard Match'|t('redirect-manager'), colorKey: 'wildcard'},
                        {value: 'prefix', label: 'Prefix Match'|t('redirect-manager'), colorKey: 'prefix'},
                    ],
                },
                {
                    header: 'Creation Type'|t('redirect-manager'),
                    param: 'creationType',
                    current: creationTypeFilter,
                    colorSet: 'creationType',
                    options: [
                        {value: 'all', label: 'All'|t('redirect-manager'), status: 'all'},
                        {value: 'manual', label: 'Manual'|t('redirect-manager'), colorKey: 'manual'},
                        {value: 'entry-change', label: 'Auto-created'|t('redirect-manager'), colorKey: 'entry-change'},
                    ],
                },
            ],
        },
    ],
    search: {
        placeholder: 'Search {pluginName}...'|t('redirect-manager', {pluginName: redirectHelper.pluralLowerDisplayName}),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'sourceUrl', label: 'Source URL'|t('redirect-manager'), sortable: true},
            {key: 'destinationUrl', label: 'Destination URL'|t('redirect-manager')},
            {key: 'matchType', label: 'Match'|t('redirect-manager'), sortable: true, hideable: true},
            {key: 'creationType', label: 'Type'|t('redirect-manager'), sortable: true, hideable: true},
            {key: 'siteId', label: 'Site'|t('redirect-manager'), sortable: true, hideable: true},
            {key: 'statusCode', label: 'Status'|t('redirect-manager'), sortable: true, hideable: true},
            {key: 'hitCount', label: 'Hits'|t('redirect-manager'), sortable: true, hideable: true},
            {key: 'enabled', label: 'Enabled'|t('redirect-manager'), sortable: true},
            {key: 'sourcePlugin', label: 'Source'|t('redirect-manager'), sortable: true, hideable: true},
        ],
        items: redirects,
        emptyMessage: 'No {items} found.'|t('redirect-manager', {items: redirectHelper.pluralLowerDisplayName}),
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: redirectHelper.lowerDisplayName, plural: redirectHelper.pluralLowerDisplayName},
    },
    checkboxes: canEdit or canDelete,
    rowActions: canEdit or canDelete,
    newButton: canCreate ? {
        url: url('redirect-manager/redirects/new'),
        label: 'New {singularName}'|t('redirect-manager', {singularName: redirectHelper.displayName}),
        permission: 'redirectManager:createRedirects',
    } : null,
} %}

{% block tableRow %}
    {# Source URL column #}
    <td data-column="sourceUrl">
        {% if canEdit %}
            <a class="label-link" href="{{ url('redirect-manager/redirects/' ~ item.id) }}">
                <span>{{ item.sourceUrl }}</span>
            </a>
        {% else %}
            <span>{{ item.sourceUrl }}</span>
        {% endif %}
    </td>

    {# Destination URL column #}
    <td data-column="destinationUrl">{{ item.destinationUrl }}</td>

    {# Match Type column #}
    <td data-column="matchType" class="lr-hideable-column">
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.matchType|capitalize,
            value: item.matchType,
            colorSet: 'matchType',
        } only %}
    </td>

    {# Creation Type column #}
    <td data-column="creationType" class="lr-hideable-column">
        {% set creationLabel = item.creationType == 'manual' ? 'Manual' : 'Auto' %}
        {% include 'lindemannrock-base/_components/badge' with {
            label: creationLabel|t('redirect-manager'),
            value: item.creationType,
            colorSet: 'creationType',
        } only %}
    </td>

    {# Site column #}
    <td data-column="siteId" class="lr-hideable-column">
        <span class="light">
            {% if item.siteId %}
                {% set site = craft.app.sites.getSiteById(item.siteId) %}
                {{ site ? site.name : 'Site ' ~ item.siteId }}
            {% else %}
                {{ 'All Sites'|t('redirect-manager') }}
            {% endif %}
        </span>
    </td>

    {# Status Code column #}
    <td data-column="statusCode" class="lr-hideable-column">{{ item.statusCode }}</td>

    {# Hits column #}
    <td data-column="hitCount" class="lr-hideable-column">{{ item.hitCount }}</td>

    {# Enabled column #}
    <td data-column="enabled">
        {% if item.enabled %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Enabled'|t('redirect-manager'),
                value: 'enabled',
                colorSet: 'status',
            } only %}
        {% else %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Disabled'|t('redirect-manager'),
                value: 'disabled',
                colorSet: 'status',
            } only %}
        {% endif %}
    </td>

    {# Source Plugin column #}
    <td data-column="sourcePlugin" class="lr-hideable-column">
        <span class="light">
            {% if item.sourcePlugin == 'redirect-manager' %}
                {% if item.creationType == 'entry-change' %}
                    {{ 'Entry Changes'|t('redirect-manager') }}
                {% else %}
                    {{ 'User'|t('redirect-manager') }}
                {% endif %}
            {% else %}
                {{ lrPluginName(item.sourcePlugin, item.sourcePlugin|replace({'-': ' '})|title) }}
            {% endif %}
        </span>
    </td>
{% endblock %}

{% block rowActions %}
    {% set hasRowActions = canEdit or canDelete %}
    {% if hasRowActions %}
        <td class="thin" style="text-align: right;">
            <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('app') }}"></button>
            <div class="menu">
                <ul>
                    {% if canEdit %}
                        <li>
                            <a href="{{ url('redirect-manager/redirects/' ~ item.id) }}">
                                {{ 'Edit'|t('app') }}
                            </a>
                        </li>
                    {% endif %}
                    {% if canDelete %}
                        {% if canEdit %}
                            <li><hr class="padded"></li>
                        {% endif %}
                        <li>
                            <a class="error row-delete-btn" data-id="{{ item.id }}">
                                {{ 'Delete'|t('app') }}
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </td>
    {% else %}
        <td class="thin"></td>
    {% endif %}
{% endblock %}

{% block bulkActions %}
    {% if canEdit %}
        <div>
            <button type="button" class="btn menubtn secondary" id="lr-bulk-status-btn" aria-label="{{ 'Set status'|t('app') }}">
                {{ 'Set status'|t('app') }}
            </button>
            <div class="menu">
                <ul>
                    <li><a id="lr-bulk-enable-action">{{ 'Enable'|t('redirect-manager') }}</a></li>
                    <li><a id="lr-bulk-disable-action">{{ 'Disable'|t('redirect-manager') }}</a></li>
                </ul>
            </div>
        </div>
    {% endif %}
    {% if canDelete %}
        <div>
            <button type="button" class="btn secondary menubtn" data-icon="settings" title="{{ 'Actions'|t('app') }}" id="lr-bulk-actions-btn"></button>
            <div class="menu">
                <ul>
                    <li><a id="lr-bulk-delete-action" class="error">{{ 'Deleteâ€¦'|t('app') }}</a></li>
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block extraFooter %}
    {% if canImportExport %}
        <a href="{{ url('redirect-manager/import-export') }}" class="btn">
            {{ 'Import'|t('redirect-manager') }}
        </a>
        {% include 'lindemannrock-base/_components/export-menu' with {
            action: 'redirect-manager/import-export/export',
            permission: 'redirectManager:manageImportExport',
            pluginHandle: pluginHandle,
            selectionAware: true,
            idsParam: 'redirectIds',
        } only %}
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    const canEdit = {{ canEdit ? 'true' : 'false' }};
    const canDelete = {{ canDelete ? 'true' : 'false' }};

    // Selection state (managed by cp-table layout)
    let selectedIds = new Set();

    // Listen for selection changes from cp-table
    document.addEventListener('lr:selectionChanged', function(e) {
        selectedIds = new Set(e.detail.selectedIds);
    });

    // Initialize bulk action menu buttons
    const bulkStatusBtn = document.getElementById('lr-bulk-status-btn');
    if (bulkStatusBtn && typeof Craft !== 'undefined' && Craft.MenuBtn) {
        new Craft.MenuBtn(bulkStatusBtn);
    }

    const bulkActionsBtn = document.getElementById('lr-bulk-actions-btn');
    if (bulkActionsBtn && typeof Craft !== 'undefined' && Craft.MenuBtn) {
        new Craft.MenuBtn(bulkActionsBtn);
    }

    // Bulk enable
    document.getElementById('lr-bulk-enable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = Array.from(selectedIds);
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'redirect-manager/redirects/bulk-enable', {
            data: { redirectIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(`Enabled ${response.data.updated} redirect${response.data.updated > 1 ? 's' : ''}`);
                setTimeout(() => window.location.reload(), 1000);
            }
        });
    });

    // Bulk disable
    document.getElementById('lr-bulk-disable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = Array.from(selectedIds);
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'redirect-manager/redirects/bulk-disable', {
            data: { redirectIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(`Disabled ${response.data.updated} redirect${response.data.updated > 1 ? 's' : ''}`);
                setTimeout(() => window.location.reload(), 1000);
            }
        });
    });

    // Bulk delete
    document.getElementById('lr-bulk-delete-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = Array.from(selectedIds);
        if (ids.length === 0) return;

        if (!confirm(`Delete ${ids.length} redirect${ids.length > 1 ? 's' : ''}?`)) return;

        Craft.sendActionRequest('POST', 'redirect-manager/redirects/bulk-delete', {
            data: { redirectIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(`Deleted ${response.data.deleted} redirects`);
                setTimeout(() => window.location.reload(), 1000);
            }
        });
    });

    // Individual delete buttons
    function attachDeleteListeners() {
        document.querySelectorAll('.row-delete-btn').forEach(deleteBtn => {
            if (deleteBtn._hasListener) return;
            deleteBtn._hasListener = true;

            deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const row = this.closest('tr');
                const id = this.dataset.id;

                if (!confirm('Delete this redirect?')) return;

                Craft.sendActionRequest('POST', 'redirect-manager/redirects/delete', {
                    data: { redirectId: id }
                }).then(function(response) {
                    if (response.data.success) {
                        row.remove();
                        Craft.cp.displayNotice('Redirect deleted');
                    }
                });
            });
        });
    }
    attachDeleteListeners();
})();
</script>
{% endblock %}
