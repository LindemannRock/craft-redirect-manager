{#
 # Per-Redirect Analytics Tab
 #
 # Uses the base plugin's analytics-panel partial for consistent styling.
 #
 # Variables available:
 # - redirect: The redirect record
 #}

{# Get date range from URL #}
{% set dateRange = craft.app.request.getQueryParam('range') ?? 'last30days' %}

{# Get analytics data for this redirect #}
{% set analytics = craft.redirectManager.getRedirectAnalytics(redirect.id, dateRange) %}

{% embed 'lindemannrock-base/_partials/analytics-panel' with {
    config: {
        pluginHandle: pluginHandle,
        dateRange: {
            enabled: true,
            current: dateRange,
            param: 'range',
            hash: 'analytics',
        },
        export: {
            action: 'redirect-manager/analytics/export',
            permission: 'redirectManager:exportAnalytics',
            extraParams: {redirectId: redirect.id},
        },
    }
} %}
    {% block content %}
        {# Stats Overview #}
        <div class="lr-unified-cards">
            {% include 'lindemannrock-base/_components/cards/unified-card' with {
                value: analytics.totalHits,
                description: 'Total Hits'|t('redirect-manager'),
                align: 'center',
            } only %}

            {% include 'lindemannrock-base/_components/cards/unified-card' with {
                value: analytics.botVsHuman.human,
                description: 'Human Visits'|t('redirect-manager'),
                align: 'center',
            } only %}

            {% include 'lindemannrock-base/_components/cards/unified-card' with {
                value: analytics.botVsHuman.bot,
                description: 'Bot Visits'|t('redirect-manager'),
                align: 'center',
            } only %}
        </div>

        {% if analytics.totalHits > 0 %}
            <div class="lr-analytics-charts two-columns">
                {# Top Referrers #}
                {% if analytics.referrerBreakdown|length > 0 %}
                <div class="lr-chart-container">
                    <h3>{{ "Top Referrers"|t('redirect-manager') }}</h3>
                    <div class="lr-table-scroll">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ "Source"|t('redirect-manager') }}</th>
                                    <th class="thin">{{ "Hits"|t('redirect-manager') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for referrer, count in analytics.referrerBreakdown %}
                                    <tr>
                                        <td>
                                            <code style="font-size: 12px;">{{ referrer }}</code>
                                        </td>
                                        <td class="thin">{{ count|number_format }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                {# Device Breakdown #}
                {% if analytics.deviceBreakdown|length > 0 %}
                <div class="lr-chart-container">
                    <h3>{{ "Devices"|t('redirect-manager') }}</h3>
                    <div class="lr-table-scroll">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ "Device"|t('redirect-manager') }}</th>
                                    <th class="thin">{{ "Hits"|t('redirect-manager') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device, count in analytics.deviceBreakdown %}
                                    <tr>
                                        <td>{{ device|capitalize }}</td>
                                        <td class="thin">{{ count|number_format }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                {# Browser Breakdown #}
                {% if analytics.browserBreakdown|length > 0 %}
                <div class="lr-chart-container">
                    <h3>{{ "Browsers"|t('redirect-manager') }}</h3>
                    <div class="lr-table-scroll">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ "Browser"|t('redirect-manager') }}</th>
                                    <th class="thin">{{ "Hits"|t('redirect-manager') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for browser, count in analytics.browserBreakdown %}
                                    <tr>
                                        <td>{{ browser }}</td>
                                        <td class="thin">{{ count|number_format }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                {# Country Breakdown #}
                {% if analytics.countryBreakdown|length > 0 %}
                <div class="lr-chart-container">
                    <h3>{{ "Countries"|t('redirect-manager') }}</h3>
                    <div class="lr-table-scroll">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ "Country"|t('redirect-manager') }}</th>
                                    <th class="thin">{{ "Hits"|t('redirect-manager') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for country, count in analytics.countryBreakdown %}
                                    <tr>
                                        <td>{{ country == 'Unknown' ? country : country|upper }}</td>
                                        <td class="thin">{{ count|number_format }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        {% else %}
            <div class="lr-analytics-empty">
                <p>{{ "No analytics data for this redirect yet."|t('redirect-manager') }}</p>
                <p class="light">{{ "Data will appear here once this redirect handles some requests."|t('redirect-manager') }}</p>
            </div>
        {% endif %}
    {% endblock %}
{% endembed %}
