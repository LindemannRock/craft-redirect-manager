{#
 # Dashboard Page
 #
 # Uses the base plugin's cp-table layout for consistent styling.
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set settings = plugin.settings %}

{# Permission checks #}
{% set canCreate = currentUser.can('redirectManager:createRedirects') %}
{% set canEdit = currentUser.can('redirectManager:editRedirects') %}
{% set canClearAnalytics = currentUser.can('redirectManager:clearAnalytics') %}
{% set hasAnyActions = canCreate or canEdit or canClearAnalytics %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set handledFilter = craft.app.request.getParam('handled', 'all') %}
{% set typeFilter = typeFilter ?? craft.app.request.getParam('type', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'lastHit') %}
{% set dir = craft.app.request.getParam('dir', 'desc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}

{% set tableConfig = {
    plugin: {
        handle: 'redirect-manager',
        name: redirectHelper.fullName,
    },
    page: {
        title: 'Dashboard'|t('redirect-manager'),
        subnav: 'dashboard',
        crumbs: [
            { label: redirectHelper.fullName, url: url('redirect-manager') },
            { label: 'Dashboard'|t('redirect-manager'), url: url('redirect-manager/dashboard') },
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'handled',
            current: handledFilter,
            label: handledFilter == 'all' ? 'All'|t('redirect-manager') : handledFilter|capitalize,
            groups: [
                {
                    param: 'handled',
                    current: handledFilter,
                    options: [
                        {value: 'all', label: 'All'|t('redirect-manager'), count: allCount, status: 'all', extraParams: {type: 'all'}},
                        {value: 'handled', label: 'Handled'|t('redirect-manager'), count: handledCount, colorKey: 'yes', statusColor: handledFilter == 'handled' ? '#10b981' : null},
                        {value: 'unhandled', label: 'Unhandled'|t('redirect-manager'), count: unhandledCount, colorKey: 'no', statusColor: handledFilter == 'unhandled' ? '#ef4444' : null},
                    ],
                },
                {
                    header: 'Request Type'|t('redirect-manager'),
                    param: 'type',
                    current: typeFilter,
                    colorSet: 'requestType',
                    options: [
                        {value: 'all', label: 'All Types'|t('redirect-manager'), status: 'all'},
                        {value: 'normal', label: 'Normal'|t('redirect-manager'), count: normalCount, colorKey: 'normal'},
                        {value: 'bot', label: 'Bot'|t('redirect-manager'), count: botCount, colorKey: 'bot'},
                        {value: 'probe', label: 'Security Probe'|t('redirect-manager'), count: probeCount, colorKey: 'probe'},
                    ],
                },
            ],
        },
    ],
    search: {
        placeholder: 'Search URLs...'|t('redirect-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'url', label: 'URL'|t('redirect-manager'), sortable: true},
            {key: 'siteId', label: 'Site'|t('redirect-manager'), sortable: true},
            {key: 'referrer', label: 'Referrer'|t('redirect-manager')},
            {key: 'count', label: 'Hits'|t('redirect-manager'), sortable: true, hideable: true},
            {key: 'lastHit', label: 'Last Hit'|t('redirect-manager'), sortable: true},
            {key: 'handled', label: 'Handled'|t('redirect-manager'), sortable: true},
            {key: 'deviceType', label: 'Device'|t('redirect-manager'), sortable: true, hideable: true},
            {key: 'browser', label: 'Browser'|t('redirect-manager'), sortable: true, hideable: true},
            {key: 'requestType', label: 'Type'|t('redirect-manager'), sortable: true, hideable: true},
        ],
        items: analytics,
        emptyMessage: 'No analytics found.'|t('redirect-manager'),
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: '404', plural: '404s'},
    },
    checkboxes: canClearAnalytics or currentUser.can('redirectManager:exportAnalytics'),
    rowActions: hasAnyActions,
    newButton: canCreate ? {
        url: url('redirect-manager/redirects/new'),
        label: 'New {singularName}'|t('redirect-manager', {singularName: redirectHelper.displayName}),
        permission: 'redirectManager:createRedirects',
    } : null,
    ajax: {
        enabled: settings.refreshIntervalSecs > 0,
        interval: settings.refreshIntervalSecs,
        endpoint: actionUrl('redirect-manager/analytics/get-dashboard-data'),
    },
} %}

{% block tableRow %}
    {# URL column #}
    <td data-column="url" style="min-width: 200px; max-width: 50%; word-break: break-word;">
        {% set isSafeUrl = item.url starts with '/' or item.url starts with 'http://' or item.url starts with 'https://' %}
        {% if isSafeUrl %}
            <a class="label-link" href="{{ item.url }}" target="_blank" rel="noopener noreferrer" title="{{ 'Visit URL'|t('redirect-manager') }}">
                <span>
                    <code style="white-space: normal; word-break: break-word; overflow-wrap: break-word;">{{ item.url }}</code>
                </span>
            </a>
        {% else %}
            <span>
                <code style="white-space: normal; word-break: break-word; overflow-wrap: break-word;">{{ item.url }}</code>
            </span>
        {% endif %}
    </td>

    {# Site column #}
    <td data-column="siteId">
        {% set site = craft.app.sites.getSiteById(item.siteId) %}
        <span class="light">{{ site ? site.name : '-' }}</span>
    </td>

    {# Referrer column #}
    <td data-column="referrer" style="max-width: 30%; word-break: break-word; overflow-wrap: break-word;">
        {{ item.referrer ?: '-' }}
    </td>

    {# Hits column #}
    <td data-column="count" class="lr-hideable-column">{{ item.count }}</td>

    {# Last Hit column #}
    <td data-column="lastHit" style="white-space: nowrap;">{{ item.lastHit|lrDatetime('short') }}</td>

    {# Handled column #}
    <td data-column="handled">
        {% if item.handled %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Yes'|t('redirect-manager'),
                value: 'yes',
                colorSet: 'yesNo',
                url: item.redirectId ? url('redirect-manager/redirects/' ~ item.redirectId) : null,
                title: item.redirectId ? 'Edit handling redirect'|t('redirect-manager') : null,
            } only %}
        {% else %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'No'|t('redirect-manager'),
                value: 'no',
                colorSet: 'yesNo',
            } only %}
        {% endif %}
    </td>

    {# Device column #}
    <td data-column="deviceType" class="lr-hideable-column">{{ item.deviceType ? item.deviceType|capitalize : '-' }}</td>

    {# Browser column #}
    <td data-column="browser" class="lr-hideable-column">{{ item.browser ?: '-' }}</td>

    {# Request Type column #}
    <td data-column="requestType" class="lr-hideable-column">
        {% set rType = item.requestType|default('normal') %}
        {% set typeLabel = rType == 'probe' ? 'Probe' : (rType == 'bot' ? 'Bot' : 'Normal') %}
        {% set typeTitle = rType == 'probe' ? 'Security vulnerability scanning attempt'|t('redirect-manager') : (rType == 'bot' ? (item.botName ?: 'Bot') : 'Regular browser request'|t('redirect-manager')) %}
        {% include 'lindemannrock-base/_components/badge' with {
            label: typeLabel|t('redirect-manager'),
            value: rType,
            colorSet: 'requestType',
            title: typeTitle,
        } only %}
    </td>
{% endblock %}

{% block rowActions %}
    {% set hasRedirectAction = (item.handled and item.redirectId and canEdit) or (not item.handled and canCreate) %}
    {% set hasRowActions = hasRedirectAction or canClearAnalytics %}
    {% if hasRowActions %}
        <td class="thin" style="text-align: right;">
            <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('redirect-manager') }}"></button>
            <div class="menu">
                <ul>
                    {% if item.handled and item.redirectId and canEdit %}
                        <li>
                            <a href="{{ url('redirect-manager/redirects/' ~ item.redirectId) }}">
                                {{ 'Edit {item}'|t('redirect-manager', {item: redirectHelper.lowerDisplayName}) }}
                            </a>
                        </li>
                    {% elseif not item.handled and canCreate %}
                        <li>
                            <a href="{{ url('redirect-manager/redirects/new', { sourceUrl: item.url }) }}">
                                {{ 'Create {item}'|t('redirect-manager', {item: redirectHelper.lowerDisplayName}) }}
                            </a>
                        </li>
                    {% endif %}
                    {% if canClearAnalytics %}
                        {% if hasRedirectAction %}
                            <li><hr class="padded"></li>
                        {% endif %}
                        <li>
                            <a class="error row-delete-action" data-id="{{ item.id }}">
                                {{ 'Delete'|t('app') }}
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </td>
    {% else %}
        <td class="thin"></td>
    {% endif %}
{% endblock %}

{% block bulkActions %}
    {# Bulk actions handled in extraFooter for consistent layout #}
{% endblock %}

{% block extraFooter %}
    {% if currentUser.can('redirectManager:clearAnalytics') %}
        <button type="button" class="btn secondary" id="lr-clear-btn">
            <span id="lr-clear-label">{{ 'Clear All'|t('redirect-manager') }}</span>
        </button>
    {% endif %}
    {% if currentUser.can('redirectManager:exportAnalytics') %}
        {% include 'lindemannrock-base/_components/export-menu' with {
            action: 'redirect-manager/analytics/export',
            permission: 'redirectManager:exportAnalytics',
            selectionAware: true,
            idsParam: 'analyticIds',
            extraParams: {dateRange: 'all'},
        } only %}
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    const handledFilter = '{{ handledFilter }}';
    const typeFilter = '{{ typeFilter }}';
    const canEdit = {{ canEdit ? 'true' : 'false' }};
    const canCreate = {{ canCreate ? 'true' : 'false' }};
    const canClearAnalytics = {{ canClearAnalytics ? 'true' : 'false' }};
    const redirectHelper = {
        lowerDisplayName: '{{ redirectHelper.lowerDisplayName|e('js') }}'
    };

    // Selection state
    let selectedIds = new Set();

    // Listen for selection changes
    document.addEventListener('lr:selectionChanged', function(e) {
        selectedIds = new Set(e.detail.selectedIds);
        updateActionLabels();
    });

    function updateActionLabels() {
        const clearLabel = document.getElementById('lr-clear-label');

        if (selectedIds.size > 0) {
            // Show count in label
            if (clearLabel) clearLabel.textContent = `{{ 'Clear'|t('redirect-manager') }} (${selectedIds.size})`;
        } else {
            // Show "Clear All"
            if (clearLabel) clearLabel.textContent = `{{ 'Clear All'|t('redirect-manager') }}`;
        }
    }

    // Clear button - handles both selected items and clear all
    document.getElementById('lr-clear-btn')?.addEventListener('click', function() {
        const ids = Array.from(selectedIds);

        if (ids.length > 0) {
            // Clear selected items
            if (!confirm(`Delete ${ids.length} analytics record${ids.length > 1 ? 's' : ''}?`)) {
                return;
            }

            const deletePromises = ids.map(id =>
                Craft.sendActionRequest('POST', 'redirect-manager/analytics/delete', {
                    data: { analyticId: id }
                })
            );

            Promise.all(deletePromises).then(() => {
                Craft.cp.displayNotice(`Deleted ${ids.length} analytics`);
                setTimeout(() => window.location.reload(), 1000);
            });
        } else {
            // Clear all
            if (!confirm('{{ "Are you sure you want to clear ALL analytics? This cannot be undone."|t("redirect-manager")|e("js") }}')) {
                return;
            }

            Craft.sendActionRequest('POST', 'redirect-manager/analytics/clear-all', { data: {} }).then(function(response) {
                if (response.data.success) {
                    Craft.cp.displayNotice(`Cleared ${response.data.deleted} analytics`);
                    setTimeout(() => window.location.reload(), 1000);
                }
            });
        }
    });

    // Individual delete via menu action
    function attachDeleteListeners() {
        document.querySelectorAll('.row-delete-action').forEach(deleteLink => {
            if (deleteLink._hasListener) return;
            deleteLink._hasListener = true;

            deleteLink.addEventListener('click', function(e) {
                e.preventDefault();
                const row = this.closest('tr');
                const id = this.dataset.id;

                if (!confirm('Delete this analytics record?')) return;

                Craft.sendActionRequest('POST', 'redirect-manager/analytics/delete', {
                    data: { analyticId: id }
                }).then(function(response) {
                    if (response.data.success) {
                        row.remove();
                        Craft.cp.displayNotice('Analytics record deleted');
                    }
                });
            });
        });
    }
    attachDeleteListeners();

    // Check if URL has a safe scheme
    function isSafeUrl(url) {
        if (!url || typeof url !== 'string') return false;
        return url.startsWith('/') || url.startsWith('http://') || url.startsWith('https://');
    }

    // Render a table row from analytics data (for AJAX refresh)
    function renderRow(stat) {
        const handled = stat.handled == 1 || stat.handled === true;
        const requestType = stat.requestType || 'normal';

        // Handled badge
        let handledCell = '';
        if (handled) {
            if (stat.redirectId) {
                handledCell = `<a href="{{ url('redirect-manager/redirects') }}/${stat.redirectId}" title="{{ 'Edit handling redirect'|t('redirect-manager')|e('js') }}" style="text-decoration: none;"><span class="status-label green"><span class="status green"></span><span class="status-label-text">{{ 'Yes'|t('redirect-manager')|e('js') }}</span></span></a>`;
            } else {
                handledCell = `<span class="status-label green"><span class="status green"></span><span class="status-label-text">{{ 'Yes'|t('redirect-manager')|e('js') }}</span></span>`;
            }
        } else {
            handledCell = `<span class="status-label red"><span class="status red"></span><span class="status-label-text">{{ 'No'|t('redirect-manager')|e('js') }}</span></span>`;
        }

        // Type badge
        let typeCell = '';
        let typeTitle = '';
        if (requestType === 'probe') {
            typeTitle = '{{ "Security vulnerability scanning attempt"|t("redirect-manager")|e("js") }}';
            typeCell = `<span title="${typeTitle}"><span class="status-label red"><span class="status red"></span><span class="status-label-text">{{ 'Probe'|t('redirect-manager')|e('js') }}</span></span></span>`;
        } else if (requestType === 'bot') {
            typeTitle = Craft.escapeHtml(stat.botName || 'Bot');
            typeCell = `<span title="${typeTitle}"><span class="status-label amber"><span class="status amber"></span><span class="status-label-text">{{ 'Bot'|t('redirect-manager')|e('js') }}</span></span></span>`;
        } else {
            typeTitle = '{{ "Regular browser request"|t("redirect-manager")|e("js") }}';
            typeCell = `<span title="${typeTitle}"><span class="status-label blue"><span class="status blue"></span><span class="status-label-text">{{ 'Normal'|t('redirect-manager')|e('js') }}</span></span></span>`;
        }

        // Build action menu item
        let actionMenuItem = '';
        if (canEdit && handled && stat.redirectId) {
            actionMenuItem = `<li><a href="{{ url('redirect-manager/redirects') }}/${stat.redirectId}">{{ 'Edit {item}'|t('redirect-manager', {item: redirectHelper.lowerDisplayName})|e('js') }}</a></li>`;
        } else if (canCreate && !handled) {
            actionMenuItem = `<li><a href="{{ url('redirect-manager/redirects/new') }}?sourceUrl=${encodeURIComponent(stat.url)}">{{ 'Create {item}'|t('redirect-manager', {item: redirectHelper.lowerDisplayName})|e('js') }}</a></li>`;
        }

        const hasRowActions = actionMenuItem !== '' || canClearAnalytics;

        return `
            <tr class="lr-data-row" data-id="${stat.id}" data-entry-id="${stat.id}">
                <td class="lr-checkbox-cell">
                    <div class="checkbox" title="{{ 'Select'|t('app')|e('js') }}" tabindex="0" aria-checked="false" role="checkbox"></div>
                </td>
                <td data-column="url" style="min-width: 200px; max-width: 50%; word-break: break-word;">
                    ${isSafeUrl(stat.url)
                        ? `<a class="label-link" href="${encodeURI(stat.url)}" target="_blank" rel="noopener noreferrer" title="{{ 'Visit URL'|t('redirect-manager')|e('js') }}"><span><code style="white-space: normal; word-break: break-word; overflow-wrap: break-word;">${Craft.escapeHtml(stat.url)}</code></span></a>`
                        : `<span><code style="white-space: normal; word-break: break-word; overflow-wrap: break-word;">${Craft.escapeHtml(stat.url)}</code></span>`
                    }
                </td>
                <td data-column="siteId"><span class="light">${Craft.escapeHtml(stat.siteName)}</span></td>
                <td data-column="referrer" style="max-width: 30%; word-break: break-word; overflow-wrap: break-word;">${stat.referrer ? Craft.escapeHtml(stat.referrer) : '-'}</td>
                <td data-column="count" class="lr-hideable-column">${stat.count}</td>
                <td data-column="lastHit" style="white-space: nowrap;">${stat.lastHit}</td>
                <td data-column="handled">${handledCell}</td>
                <td data-column="deviceType" class="lr-hideable-column">${stat.deviceType ? stat.deviceType.charAt(0).toUpperCase() + stat.deviceType.slice(1) : '-'}</td>
                <td data-column="browser" class="lr-hideable-column">${stat.browser ? Craft.escapeHtml(stat.browser) : '-'}</td>
                <td data-column="requestType" class="lr-hideable-column">${typeCell}</td>
                ${hasRowActions ? `
                <td class="thin" style="text-align: right;">
                    <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('redirect-manager')|e('js') }}"></button>
                    <div class="menu">
                        <ul>
                            ${actionMenuItem}
                            ${canClearAnalytics ? `${actionMenuItem ? '<li><hr class="padded"></li>' : ''}<li><a class="error row-delete-action" data-id="${stat.id}">{{ 'Delete'|t('app')|e('js') }}</a></li>` : ''}
                        </ul>
                    </div>
                </td>
                ` : '<td class="thin"></td>'}
            </tr>
        `;
    }

    // Listen for AJAX refresh events from cp-table layout
    document.addEventListener('lr:refresh', function(e) {
        const data = e.detail;

        // Update table body
        const tbody = document.getElementById('lr-table-body');
        if (tbody && data.analytics) {
            if (data.analytics.length > 0) {
                tbody.innerHTML = data.analytics.map(stat => renderRow(stat)).join('');

                // Re-initialize menu buttons
                tbody.querySelectorAll('.menubtn').forEach(btn => {
                    if (!btn._menuBtn) {
                        if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
                            btn._menuBtn = new Craft.MenuBtn(btn);
                        }
                    }
                });

                // Re-attach delete listeners
                attachDeleteListeners();

                // Note: Checkbox listeners are re-bound by cp-table's lr:refresh handler
            } else {
                tbody.innerHTML = `<tr class="lr-empty-row"><td colspan="11" style="text-align: center; padding: 2em;">{{ 'No analytics found.'|t('redirect-manager')|e('js') }}</td></tr>`;
            }
        }

        // Update filter counts in menu
        const allCountEl = document.querySelector('.menu a[href*="handled=all"][href*="type=all"]');
        const handledCountEl = document.querySelector('.menu a[href*="handled=handled"]');
        const unhandledCountEl = document.querySelector('.menu a[href*="handled=unhandled"]');
        const normalCountEl = document.querySelector('.menu a[href*="type=normal"]');
        const botCountEl = document.querySelector('.menu a[href*="type=bot"]');
        const probeCountEl = document.querySelector('.menu a[href*="type=probe"]');

        if (allCountEl) allCountEl.innerHTML = `<span class="status all"></span>{{ 'All'|t('redirect-manager')|e('js') }} (${data.allCount})`;
        if (handledCountEl) handledCountEl.innerHTML = `<span class="status" style="background: ${handledFilter == 'handled' ? '#10b981' : '#aab6c1'};"></span>{{ 'Handled'|t('redirect-manager')|e('js') }} (${data.handledCount})`;
        if (unhandledCountEl) unhandledCountEl.innerHTML = `<span class="status" style="background: ${handledFilter == 'unhandled' ? '#ef4444' : '#aab6c1'};"></span>{{ 'Unhandled'|t('redirect-manager')|e('js') }} (${data.unhandledCount})`;
        if (normalCountEl) normalCountEl.innerHTML = `<span class="status" style="background: ${typeFilter == 'normal' ? '#3b82f6' : '#aab6c1'};"></span>{{ 'Normal'|t('redirect-manager')|e('js') }} (${data.normalCount})`;
        if (botCountEl) botCountEl.innerHTML = `<span class="status" style="background: ${typeFilter == 'bot' ? '#f59e0b' : '#aab6c1'};"></span>{{ 'Bot'|t('redirect-manager')|e('js') }} (${data.botCount})`;
        if (probeCountEl) probeCountEl.innerHTML = `<span class="status" style="background: ${typeFilter == 'probe' ? '#ef4444' : '#aab6c1'};"></span>{{ 'Security Probe'|t('redirect-manager')|e('js') }} (${data.probeCount})`;
    });

    // Initialize action label state
    updateActionLabels();
})();
</script>
{% endblock %}
