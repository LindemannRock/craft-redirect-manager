{% extends 'lindemannrock-base/_layouts/cp-utilities' %}

{# Permission checks #}
{% set hasRedirectsAccess = currentUser.can('redirectManager:viewRedirects') or currentUser.can('redirectManager:createRedirects') or currentUser.can('redirectManager:editRedirects') or currentUser.can('redirectManager:deleteRedirects') %}
{% set hasAnalyticsAccess = currentUser.can('redirectManager:viewAnalytics') and settings.enableAnalytics %}
{% set hasSettingsAccess = currentUser.can('redirectManager:manageSettings') %}
{% set canClearCache = currentUser.can('redirectManager:clearCache') and (settings.enableRedirectCache or settings.cacheDeviceDetection) %}
{% set canClearAnalytics = currentUser.can('redirectManager:clearAnalytics') and settings.enableAnalytics %}

{% set hasNavigation = hasRedirectsAccess or hasAnalyticsAccess or hasSettingsAccess %}
{% set hasAnyQuickAction = hasNavigation or canClearCache or canClearAnalytics %}

{# Calculate status colors #}
{% set coverage = totalRedirects > 0 ? ((activeRedirects / totalRedirects) * 100)|round : 100 %}
{% set coverageColor = coverage == 100 ? lrPaletteColor('emerald').color : (coverage >= 90 ? lrPaletteColor('amber').color : lrPaletteColor('red').color) %}
{% set coverageBadge = coverage == 100 ? 'All Active'|t('redirect-manager') : (coverage >= 90 ? 'Good'|t('redirect-manager') : 'Check'|t('redirect-manager')) %}

{% set successRate = total404s > 0 ? ((handled / total404s) * 100)|round : 100 %}
{% set successColor = successRate >= 90 ? lrPaletteColor('emerald').color : (successRate >= 70 ? lrPaletteColor('amber').color : lrPaletteColor('red').color) %}

{% set utilitiesConfig = {
    plugin: {
        handle: 'redirect-manager',
        name: redirectHelper.fullName,
    },
    page: {
        title: 'Overview'|t('redirect-manager'),
        description: 'Monitor 404 handling, manage redirects, and optimize cache performance.'|t('redirect-manager'),
    },
} %}

{% block overview %}
    {# Redirects Status Card #}
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        title: 'Redirects Status'|t('redirect-manager'),
        color: coverageColor,
        value: coverage ~ '%',
        valueColor: coverageColor,
        badge: coverageBadge,
        badgeColor: coverageColor,
        description: 'Active {pluginName}'|t('redirect-manager', {pluginName: redirectHelper.fullName|lower}),
        subBoxes: [
            {value: totalRedirects, label: 'Total'|t('redirect-manager')},
            {value: activeRedirects, label: 'Active'|t('redirect-manager')},
        ],
    } only %}

    {# 404 Handling Card #}
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        title: '404 Handling'|t('redirect-manager'),
        color: successColor,
        value: successRate ~ '%',
        valueColor: successColor,
        description: 'Success rate (last 7 days)'|t('redirect-manager'),
        subBoxes: [
            {value: handled, label: 'Handled'|t('redirect-manager'), color: lrPaletteColor('emerald').color},
            {value: unhandled, label: 'Unhandled'|t('redirect-manager'), color: lrPaletteColor('red').color},
        ],
    } only %}

    {# Cache Status Card #}
    {% if storageMethod == 'redis' %}
        {% set cacheSubBoxes = [] %}
        {% if settings.enableRedirectCache %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: '✓', label: 'Redirects'|t('redirect-manager')}]) %}
        {% endif %}
        {% if settings.cacheDeviceDetection %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: '✓', label: 'Devices'|t('redirect-manager')}]) %}
        {% endif %}

        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Cache Status'|t('redirect-manager') ~ ' (Redis)',
            color: lrPaletteColor('emerald').color,
            value: 'Active'|t('redirect-manager'),
            subBoxes: cacheSubBoxes,
        } only %}
    {% else %}
        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Cache Status'|t('redirect-manager') ~ ' (File)',
            color: lrPaletteColor('emerald').color,
            value: deviceCacheFiles + redirectCacheFiles,
            description: 'Total cached entries'|t('redirect-manager'),
            subBoxes: [
                {value: redirectCacheFiles, label: 'Redirects'|t('redirect-manager')},
                {value: deviceCacheFiles, label: 'Devices'|t('redirect-manager')},
            ],
        } only %}
    {% endif %}
{% endblock %}

{% block quickActions %}
    {% if hasAnyQuickAction %}
        {# Navigation Section #}
        {% if hasNavigation %}
            {% set navButtons = [] %}
            {% if hasRedirectsAccess %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'Manage Redirects'|t('redirect-manager'), url: url('redirect-manager/redirects')}]) %}
            {% endif %}
            {% if hasAnalyticsAccess %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'View Analytics'|t('redirect-manager'), url: url('redirect-manager/analytics')}]) %}
            {% endif %}
            {% if hasSettingsAccess %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'View Settings'|t('redirect-manager'), url: url('redirect-manager/settings')}]) %}
            {% endif %}

            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Navigation'|t('redirect-manager'),
                description: 'Access main plugin sections'|t('redirect-manager'),
                buttons: navButtons,
            } only %}
        {% endif %}

        {# Cache Management Section #}
        {% if canClearCache %}
            {% set cacheButtons = [] %}
            {% if settings.enableRedirectCache %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-redirect-cache',
                    label: 'Clear Redirect Cache'|t('redirect-manager'),
                    count: storageMethod != 'redis' ? redirectCacheFiles : null,
                }]) %}
            {% endif %}
            {% if settings.cacheDeviceDetection %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-device-cache',
                    label: 'Clear Device Cache'|t('redirect-manager'),
                    count: storageMethod != 'redis' ? deviceCacheFiles : null,
                }]) %}
            {% endif %}
            {% if settings.enableRedirectCache and settings.cacheDeviceDetection %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-all-caches',
                    label: 'Clear All Caches'|t('redirect-manager'),
                    class: 'btn secondary',
                    count: storageMethod != 'redis' ? (redirectCacheFiles + deviceCacheFiles) : null,
                }]) %}
            {% endif %}

            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Cache Management'|t('redirect-manager'),
                description: 'Clear cached data to force regeneration. Useful when troubleshooting redirect issues.'|t('redirect-manager'),
                showSeparator: hasNavigation,
                buttons: cacheButtons,
            } only %}
        {% endif %}

        {# Analytics Management Section #}
        {% if canClearAnalytics %}
            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Analytics Data Management'|t('redirect-manager'),
                description: 'Permanently delete all analytics tracking data. This action cannot be undone!'|t('redirect-manager'),
                showSeparator: hasNavigation or canClearCache,
                buttons: [
                    {id: 'clear-all-analytics', label: 'Clear All Analytics'|t('redirect-manager'), class: 'btn secondary', count: analyticsCount},
                ],
            } only %}
        {% endif %}
    {% endif %}
{% endblock %}

{% block scripts %}
{% js %}
{% if settings.enableRedirectCache %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-redirect-cache',
    action: actionUrl('redirect-manager/settings/clear-redirect-cache'),
    errorMessage: 'Failed'|t('redirect-manager'),
} only %}
{% endif %}

{% if settings.cacheDeviceDetection %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-device-cache',
    action: actionUrl('redirect-manager/settings/clear-device-cache'),
    errorMessage: 'Failed'|t('redirect-manager'),
} only %}
{% endif %}

{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-all-caches',
    action: actionUrl('redirect-manager/settings/clear-all-caches'),
    confirm: 'Clear all caches?'|t('redirect-manager'),
    errorMessage: 'Failed'|t('redirect-manager'),
} only %}

{% if settings.enableAnalytics %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-all-analytics',
    action: actionUrl('redirect-manager/settings/clear-all-analytics'),
    confirm: 'Are you sure you want to permanently delete ALL analytics data? This action cannot be undone!'|t('redirect-manager'),
    confirmSecond: 'This will delete all 404 tracking data. Are you absolutely sure?'|t('redirect-manager'),
    errorMessage: 'Failed'|t('redirect-manager'),
    reloadDelay: 2000,
} only %}
{% endif %}
{% endjs %}
{% endblock %}
