{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set pluginName = plugin.settings.pluginName %}

<div style="margin-bottom: 32px;">
    <h2>{{ pluginName }} {{ "Overview"|t('redirect-manager') }}</h2>
    <p class="light">{{ "Monitor 404 handling, manage redirects, and optimize cache performance."|t('redirect-manager') }}</p>
</div>

<div style="margin-bottom: 40px;">
    <h2>{{ "System Overview"|t('redirect-manager') }}</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; align-items: stretch;">
        <!-- Redirects Status Card -->
        {% set coverage = totalRedirects > 0 ? ((activeRedirects / totalRedirects) * 100)|round : 100 %}
        <div class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); display: flex; flex-direction: column; height: 100%;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <div style="width: 12px; height: 12px; border-radius: 50%; background: {% if coverage == 100 %}#059669{% elseif coverage >= 90 %}#d97706{% else %}#dc2626{% endif %};"></div>
                <h4 style="margin: 0; color: #374151; font-size: 15px; font-weight: 600;">{{ "Redirects Status"|t('redirect-manager') }}</h4>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="font-size: 28px; font-weight: 700; color: {% if coverage == 100 %}#059669{% elseif coverage >= 90 %}#d97706{% else %}#dc2626{% endif %}; line-height: 1;">{{ coverage }}%</div>
                    <div style="padding: 3px 10px; border-radius: 16px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: white; background: {% if coverage == 100 %}#059669{% elseif coverage >= 90 %}#d97706{% else %}#dc2626{% endif %};">
                        {% if coverage == 100 %}{{ 'All Active'|t('redirect-manager') }}{% elseif coverage >= 90 %}{{ 'Good'|t('redirect-manager') }}{% else %}{{ 'Check'|t('redirect-manager') }}{% endif %}
                    </div>
                </div>
                <div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">{{ "Active {pluginName}"|t('redirect-manager', {pluginName: pluginName|lower}) }}</div>
                <div style="margin-top: auto;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ totalRedirects|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Total'|t('redirect-manager') }}</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ activeRedirects|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Active'|t('redirect-manager') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 404 Performance Card -->
        {% set successRate = total404s > 0 ? ((handled / total404s) * 100)|round : 0 %}
        <div class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); display: flex; flex-direction: column; height: 100%;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <div style="width: 12px; height: 12px; border-radius: 50%; background: {% if successRate >= 90 %}#10b981{% elseif successRate >= 70 %}#f59e0b{% else %}#ef4444{% endif %};"></div>
                <h4 style="margin: 0; color: #374151; font-size: 15px; font-weight: 600;">{{ "404 Handling"|t('redirect-manager') }}</h4>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="font-size: 28px; font-weight: 700; color: {% if successRate >= 90 %}#10b981{% elseif successRate >= 70 %}#f59e0b{% else %}#ef4444{% endif %}; line-height: 1; margin-bottom: 12px;">{{ successRate }}%</div>
                <div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">{{ "Success rate (last 7 days)"|t('redirect-manager') }}</div>
                <div style="margin-top: auto;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #10b981; margin-bottom: 4px;">{{ handled|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Handled'|t('redirect-manager') }}</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #ef4444; margin-bottom: 4px;">{{ unhandled|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Unhandled'|t('redirect-manager') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cache Status Card -->
        <div class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); display: flex; flex-direction: column; height: 100%;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e;"></div>
                <h4 style="margin: 0; color: #374151; font-size: 15px; font-weight: 600;">{{ "Cache Status"|t('redirect-manager') }}</h4>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1; margin-bottom: 12px;">{{ (deviceCacheFiles + redirectCacheFiles)|number_format }}</div>
                <div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">{{ "Total cached entries"|t('redirect-manager') }}</div>
                <div style="margin-top: auto;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ redirectCacheFiles|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Redirects'|t('redirect-manager') }}</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ deviceCacheFiles|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Devices'|t('redirect-manager') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div>
    <h2>{{ 'Quick Actions'|t('redirect-manager') }}</h2>

    <div class="pane">
        <div style="margin-bottom: 24px;">
            <h3>{{ "Navigation"|t('redirect-manager') }}</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="{{ url('redirect-manager/redirects') }}" class="btn">{{ "Manage Redirects"|t('redirect-manager') }}</a>
                <a href="{{ url('redirect-manager/analytics') }}" class="btn">{{ "View Analytics"|t('redirect-manager') }}</a>
            </div>
        </div>

        <hr style="margin: 24px 0;">

        <div style="margin-bottom: 24px;">
            <h3>{{ "Cache Management"|t('redirect-manager') }}</h3>
            <p class="light" style="margin-bottom: 16px;">{{ "Clear cached data to force regeneration. Useful when troubleshooting redirect issues."|t('redirect-manager') }}</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                {% if settings.enableRedirectCache %}
                    <button type="button" class="btn" id="clear-redirect-cache">{{ "Clear Redirect Cache"|t('redirect-manager') }} ({{ redirectCacheFiles }})</button>
                {% endif %}
                {% if settings.cacheDeviceDetection %}
                    <button type="button" class="btn" id="clear-device-cache">{{ "Clear Device Cache"|t('redirect-manager') }} ({{ deviceCacheFiles }})</button>
                {% endif %}
                <button type="button" class="btn secondary" id="clear-all-caches">{{ "Clear All Caches"|t('redirect-manager') }} ({{ (redirectCacheFiles + deviceCacheFiles) }})</button>
            </div>
        </div>

        <hr style="margin: 24px 0;">

        <div>
            <h3>{{ "Analytics Data Management"|t('redirect-manager') }}</h3>
            <p class="light">{{ "Permanently delete all analytics tracking data. This action cannot be undone!"|t('redirect-manager') }}</p>
            <button type="button" class="btn submit" id="clear-all-analytics" style="background: #dc2626; border-color: #dc2626; color: white;">{{ "Clear All Analytics"|t('redirect-manager') }}</button>
        </div>
    </div>
</div>

{% js %}
{% if settings.enableRedirectCache %}
$('#clear-redirect-cache').on('click', function() {
    const $btn = $(this);
    $btn.addClass('loading').prop('disabled', true);
    $.ajax({
        url: '{{ actionUrl('redirect-manager/settings/clear-redirect-cache')|raw }}',
        type: 'POST',
        data: { {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}' },
        success: function(response) {
            Craft.cp.displayNotice(response.message);
            setTimeout(() => window.location.reload(), 1500);
        },
        error: function() { Craft.cp.displayError('{{ "Failed"|t('redirect-manager') }}'); },
        complete: function() { $btn.removeClass('loading').prop('disabled', false); }
    });
});
{% endif %}

{% if settings.cacheDeviceDetection %}
$('#clear-device-cache').on('click', function() {
    const $btn = $(this);
    $btn.addClass('loading').prop('disabled', true);
    $.ajax({
        url: '{{ actionUrl('redirect-manager/settings/clear-device-cache')|raw }}',
        type: 'POST',
        data: { {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}' },
        success: function(response) {
            Craft.cp.displayNotice(response.message);
            setTimeout(() => window.location.reload(), 1500);
        },
        error: function() { Craft.cp.displayError('{{ "Failed"|t('redirect-manager') }}'); },
        complete: function() { $btn.removeClass('loading').prop('disabled', false); }
    });
});
{% endif %}

$('#clear-all-caches').on('click', function() {
    if (!confirm('{{ "Clear all caches?"|t('redirect-manager')|e('js') }}')) return;
    const $btn = $(this);
    $btn.addClass('loading').prop('disabled', true);
    $.ajax({
        url: '{{ actionUrl('redirect-manager/settings/clear-all-caches')|raw }}',
        type: 'POST',
        data: { {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}' },
        success: function(response) {
            Craft.cp.displayNotice(response.message);
            setTimeout(() => window.location.reload(), 1500);
        },
        complete: function() { $btn.removeClass('loading').prop('disabled', false); }
    });
});

$('#clear-all-analytics').on('click', function() {
    if (!confirm('{{ "Are you sure you want to permanently delete ALL analytics data? This action cannot be undone!"|t('redirect-manager')|e('js') }}')) return;
    if (!confirm('{{ "This will delete all 404 tracking data. Are you absolutely sure?"|t('redirect-manager')|e('js') }}')) return;

    const $btn = $(this);
    $btn.addClass('loading').prop('disabled', true);
    $.ajax({
        url: '{{ actionUrl('redirect-manager/settings/clear-all-analytics')|raw }}',
        type: 'POST',
        data: { {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}' },
        success: function(response) {
            Craft.cp.displayNotice(response.message);
            setTimeout(() => window.location.reload(), 2000);
        },
        complete: function() { $btn.removeClass('loading').prop('disabled', false); }
    });
});
{% endjs %}
