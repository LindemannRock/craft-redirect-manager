{# Overview Tab - Stats, Trend, Most Common, Recent Unhandled #}

<div class="lr-analytics-stats">
    {% include 'lindemannrock-base/_components/stat-box' with {
        value: totalCount ?? 0,
        label: 'Total 404s'|t('redirect-manager'),
        id: 'total-404s',
    } only %}

    {% include 'lindemannrock-base/_components/stat-box' with {
        value: handledCount ?? 0,
        label: 'Handled'|t('redirect-manager'),
        color: '#10b981',
        id: 'handled-404s',
    } only %}

    {% include 'lindemannrock-base/_components/stat-box' with {
        value: unhandledCount ?? 0,
        label: 'Unhandled'|t('redirect-manager'),
        color: '#ef4444',
        id: 'unhandled-404s',
    } only %}

    {% include 'lindemannrock-base/_components/stat-box' with {
        value: totalCount > 0 ? ((handledCount / totalCount * 100)|round) : 0,
        suffix: '%',
        label: 'Success Rate'|t('redirect-manager'),
        id: 'success-rate',
    } only %}
</div>

<h2 style="margin: 30px 0 20px;">{{ "404 Trend"|t('redirect-manager') }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <canvas id="404-trend-chart"></canvas>
    </div>
</div>

<h2 style="margin: 30px 0 20px;">{{ "Most Common 404s (Top 15)"|t('redirect-manager') }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <div class="lr-table-scroll">
            <table class="data fullwidth" id="most-common-table">
                <thead>
                    <tr>
                        <th>{{ 'URL'|t('redirect-manager') }}</th>
                        <th>{{ 'Site'|t('redirect-manager') }}</th>
                        <th>{{ 'Count'|t('redirect-manager') }}</th>
                        <th>{{ 'Handled'|t('redirect-manager') }}</th>
                        <th>{{ 'Last Hit'|t('redirect-manager') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in mostCommon %}
                        <tr>
                            <td>
                                <a class="label-link" href="{{ stat.url }}" target="_blank">
                                    <span><code>{{ stat.url|slice(0, 80) }}</code></span>
                                </a>
                            </td>
                            <td>
                                {% if stat.siteId %}
                                    {% set site = craft.app.sites.getSiteById(stat.siteId) %}
                                    {{ site ? site.name : '—' }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td><strong>{{ stat.count|number }}</strong></td>
                            <td>
                                {% if stat.handled %}
                                    {% include 'lindemannrock-base/_components/badge' with {
                                        label: 'Yes'|t('redirect-manager'),
                                        value: 'yes',
                                        colorSet: 'yesNo',
                                    } only %}
                                {% else %}
                                    {% include 'lindemannrock-base/_components/badge' with {
                                        label: 'No'|t('redirect-manager'),
                                        value: 'no',
                                        colorSet: 'yesNo',
                                    } only %}
                                {% endif %}
                            </td>
                            <td>{{ stat.lastHit|lrDatetime('short') }}</td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="thin light">{{ "No 404s recorded yet"|t('redirect-manager') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<h2 style="margin: 30px 0 20px;">{{ "Recent Unhandled 404s"|t('redirect-manager') }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <div class="lr-table-scroll">
            <table class="data fullwidth" id="recent-unhandled-table">
                <thead>
                    <tr>
                        <th>{{ 'URL'|t('redirect-manager') }}</th>
                        <th>{{ 'Site'|t('redirect-manager') }}</th>
                        <th>{{ 'Count'|t('redirect-manager') }}</th>
                        <th>{{ 'Referrer'|t('redirect-manager') }}</th>
                        <th>{{ 'Last Hit'|t('redirect-manager') }}</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in recentUnhandled %}
                        <tr>
                            <td>
                                <a class="label-link" href="{{ stat.url }}" target="_blank">
                                    <span><code>{{ stat.url|slice(0, 80) }}</code></span>
                                </a>
                            </td>
                            <td>
                                {% if stat.siteId %}
                                    {% set site = craft.app.sites.getSiteById(stat.siteId) %}
                                    {{ site ? site.name : '—' }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>{{ stat.count|number }}</td>
                            <td>{{ stat.referrer ? stat.referrer|slice(0, 40) : '-' }}</td>
                            <td>{{ stat.lastHit|lrDatetime('short') }}</td>
                            <td>
                                <a href="{{ url('redirect-manager/redirects/new', { sourceUrl: stat.url }) }}"
                                   class="btn submit icon add"
                                   title="{{ 'Create redirect'|t('redirect-manager') }}"></a>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="thin light">{{ "No unhandled 404s! Great job!"|t('redirect-manager') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
