{#
 # Analytics Page
 #
 # Uses the base plugin's cp-analytics layout for consistent styling.
 #}

{% extends 'lindemannrock-base/_layouts/cp-analytics' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set settings = plugin.settings %}

{# Define tabs - Geographic only if geo detection enabled #}
{% set tabsConfig = {
    overview: { label: "Overview"|t('redirect-manager') },
    'traffic-devices': { label: "Traffic & Devices"|t('redirect-manager') }
} %}

{% if settings.enableGeoDetection %}
    {% set tabsConfig = tabsConfig|merge({
        geographic: { label: "Geographic"|t('redirect-manager') }
    }) %}
{% endif %}

{% set analyticsConfig = {
    plugin: {
        handle: pluginHandle ?? 'redirect-manager',
        name: redirectHelper.fullName,
    },
    page: {
        title: 'Analytics'|t('redirect-manager'),
        subnav: 'analytics',
        crumbs: [
            { label: redirectHelper.fullName, url: url('redirect-manager') },
            { label: 'Analytics'|t('redirect-manager'), url: url('redirect-manager/analytics') },
        ],
    },
    tabs: tabsConfig,
    filters: {
        dateRange: {
            current: dateRange,
        },
        sites: {
            enabled: sites|length > 1,
            current: siteId,
            sites: sites,
        },
    },
    export: {
        permission: 'redirectManager:exportAnalytics',
        action: 'redirect-manager/analytics/export',
        extraParams: {siteId: siteId},
    },
    charts: {
        prefix: 'rm',
        dataEndpoint: 'redirect-manager/analytics/get-data',
    },
} %}

{% block tabs %}
    <div id="overview" class="lr-tab-content">
        {% include 'redirect-manager/analytics/_partials/overview' %}
    </div>

    <div id="traffic-devices" class="lr-tab-content hidden">
        {% include 'redirect-manager/analytics/_partials/traffic-devices' %}
    </div>

    {% if settings.enableGeoDetection %}
    <div id="geographic" class="lr-tab-content hidden">
        {% include 'redirect-manager/analytics/_partials/geographic' %}
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
{% do view.registerAssetBundle('lindemannrock\\redirectmanager\\web\\assets\\analytics\\AnalyticsAsset') %}

{% set redirectStrings = {
    noTrend: 'No trend data available for the selected filters.'|t('redirect-manager'),
    noBot: 'No bot data available for the selected filters.'|t('redirect-manager'),
    noDevice: 'No device data available for the selected filters.'|t('redirect-manager'),
    noBrowser: 'No browser data available for the selected filters.'|t('redirect-manager'),
    noOs: 'No OS data available for the selected filters.'|t('redirect-manager'),
    handledLabel: 'Handled'|t('redirect-manager'),
    unhandledLabel: 'Unhandled'|t('redirect-manager'),
    botTraffic: 'of traffic is from bots'|t('redirect-manager'),
    redirectsLabel: '404s'|t('redirect-manager'),
} %}

{% set redirectAnalyticsConfig = {
    prefix: analyticsConfig.charts.prefix,
    dateRange: dateRange,
    siteId: siteId ?? '',
    csrfName: craft.app.config.general.csrfTokenName,
    csrfToken: craft.app.request.csrfToken,
    dataEndpoint: analyticsConfig.charts.dataEndpoint,
    strings: redirectStrings,
} %}

{% js %}
window.lrRedirectAnalyticsInit({{ redirectAnalyticsConfig|json_encode|raw }});
{% endjs %}
{% endblock %}
