{% extends "_layouts/cp" %}
{% set title = "Analytics"|t('redirect-manager') %}
{% set selectedSubnavItem = 'analytics' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set crumbs = [
    {
        label: redirectHelper.fullName|t('redirect-manager'),
        url: url('redirect-manager'),
    },
    {
        label: 'Analytics'|t('redirect-manager'),
        url: url('redirect-manager/analytics'),
    },
] %}

{% block actionButton %}
	<div id="action-button" class="btngroup">
		<button type="button" class="btn menubtn" data-icon="download">{{ "Export"|t('redirect-manager') }}</button>
		<div class="menu" data-align="right">
			<ul>
				<li>
					<a href="#" class="export-link" data-format="csv" data-action="redirect-manager/analytics/export-csv">{{ "Export as CSV"|t('redirect-manager') }}</a>
				</li>
			</ul>
		</div>
	</div>
{% endblock %}

{% block toolbar %}
	<div class="flex">
		<div>
			<div class="btngroup">
				<button type="button" class="btn menubtn">
					<span id="dateRangeLabel">{{ dateRange == 'today' ? 'Today' : (dateRange == 'yesterday' ? 'Yesterday' : (dateRange == 'last7days' ? 'Last 7 days' : (dateRange == 'last30days' ? 'Last 30 days' : (dateRange == 'last90days' ? 'Last 90 days' : 'All time')))) }}</span>
				</button>
				<div class="menu">
					<ul>
						<li><a href="#" data-range="today" class="main-date-range-option {{ dateRange == 'today' ? 'sel' : '' }}">{{ "Today"|t('redirect-manager') }}</a></li>
						<li><a href="#" data-range="yesterday" class="main-date-range-option {{ dateRange == 'yesterday' ? 'sel' : '' }}">{{ "Yesterday"|t('redirect-manager') }}</a></li>
						<li><a href="#" data-range="last7days" class="main-date-range-option {{ dateRange == 'last7days' ? 'sel' : '' }}">{{ "Last 7 days"|t('redirect-manager') }}</a></li>
						<li><a href="#" data-range="last30days" class="main-date-range-option {{ dateRange == 'last30days' ? 'sel' : '' }}">{{ "Last 30 days"|t('redirect-manager') }}</a></li>
						<li><a href="#" data-range="last90days" class="main-date-range-option {{ dateRange == 'last90days' ? 'sel' : '' }}">{{ "Last 90 days"|t('redirect-manager') }}</a></li>
						<li><a href="#" data-range="all" class="main-date-range-option {{ dateRange == 'all' ? 'sel' : '' }}">{{ "All time"|t('redirect-manager') }}</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block content %}
    <div id="analytics-dashboard">
        <div class="analytics-stats">
            <div class="stat-box">
                <div class="stat-value" id="total-404s">{{ (totalCount ?? 0)|number }}</div>
                <div class="stat-label">{{ "Total 404s"|t('redirect-manager') }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="handled-404s">{{ (handledCount ?? 0)|number }}</div>
                <div class="stat-label">{{ "Handled"|t('redirect-manager') }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="unhandled-404s">{{ (unhandledCount ?? 0)|number }}</div>
                <div class="stat-label">{{ "Unhandled"|t('redirect-manager') }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="success-rate">{{ totalCount > 0 ? ((handledCount / totalCount * 100)|round) : 0 }}%</div>
                <div class="stat-label">{{ "Success Rate"|t('redirect-manager') }}</div>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "404 Trend"|t('redirect-manager') }}</h2>

        <div class="analytics-charts">
            <div class="chart-container full-width">
                <canvas id="404-trend-chart"></canvas>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Most Common 404s (Top 15)"|t('redirect-manager') }}</h2>

        <div class="analytics-charts">
            <div class="chart-container full-width">
                <div class="table-scroll-container">
                    <table class="data fullwidth">
                        <thead>
                            <tr>
                                <th>{{ 'URL'|t('redirect-manager') }}</th>
                                <th>{{ 'Count'|t('redirect-manager') }}</th>
                                <th>{{ 'Handled'|t('redirect-manager') }}</th>
                                <th>{{ 'Date'|t('redirect-manager') }}</th>
                                <th>{{ 'Time'|t('redirect-manager') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in mostCommon %}
                                <tr>
                                    <td>
                                        <a class="label-link" href="{{ stat.url }}" target="_blank">
                                            <span><code>{{ stat.url|slice(0, 80) }}</code></span>
                                        </a>
                                    </td>
                                    <td><strong>{{ stat.count|number }}</strong></td>
                                    <td>
                                        {% if stat.handled %}
                                            <span class="status green"></span>
                                        {% else %}
                                            <span class="status red"></span>
                                        {% endif %}
                                    </td>
                                    <td>{{ stat.lastHit|date('short') }}</td>
                                    <td>{{ stat.lastHit|time('short') }}</td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="thin light">{{ "No 404s recorded yet"|t('redirect-manager') }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Traffic Analysis"|t('redirect-manager') }}</h2>

        <div class="analytics-charts two-columns">
            <div class="chart-container">
                <h3>{{ "Bot vs Human Traffic"|t('redirect-manager') }}</h3>
                <canvas id="bot-chart"></canvas>
                <div style="text-align: center; margin-top: 10px; color: #666;">
                    <strong>{{ botStats.botPercentage }}%</strong> of traffic is from bots
                </div>
            </div>

            <div class="chart-container">
                <h3>{{ "Top Bots"|t('redirect-manager') }}</h3>
                <div class="table-scroll-container">
                    <table class="data fullwidth">
                        <thead>
                            <tr>
                                <th>{{ "Bot Name"|t('redirect-manager') }}</th>
                                <th>{{ "404s"|t('redirect-manager') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if botStats.topBots|length > 0 %}
                                {% for bot in botStats.topBots %}
                                    <tr>
                                        <td>{{ bot.botName }}</td>
                                        <td>{{ bot.count|number }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="2" style="text-align: center; color: #999;">
                                        {{ "No bot data available"|t('redirect-manager') }}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Device Analytics"|t('redirect-manager') }}</h2>

        <div class="analytics-charts two-columns">
            <div class="chart-container">
                <h3>{{ "Device Types"|t('redirect-manager') }}</h3>
                <canvas id="device-chart"></canvas>
            </div>

            <div class="chart-container">
                <h3>{{ "Browser Usage"|t('redirect-manager') }}</h3>
                <canvas id="browser-chart"></canvas>
            </div>
        </div>

        <div class="analytics-charts" style="margin-top: 30px;">
            <div class="chart-container">
                <h3>{{ "Operating Systems"|t('redirect-manager') }}</h3>
                <canvas id="os-chart"></canvas>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Recent Unhandled 404s"|t('redirect-manager') }}</h2>

        <div class="analytics-charts">
            <div class="chart-container full-width">
                <div class="table-scroll-container">
                    <table class="data fullwidth">
                        <thead>
                            <tr>
                                <th>{{ 'URL'|t('redirect-manager') }}</th>
                                <th>{{ 'Count'|t('redirect-manager') }}</th>
                                <th>{{ 'Referrer'|t('redirect-manager') }}</th>
                                <th>{{ 'Date'|t('redirect-manager') }}</th>
                                <th>{{ 'Time'|t('redirect-manager') }}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in recentUnhandled %}
                                <tr>
                                    <td>
                                        <a class="label-link" href="{{ stat.url }}" target="_blank">
                                            <span><code>{{ stat.url|slice(0, 80) }}</code></span>
                                        </a>
                                    </td>
                                    <td>{{ stat.count|number }}</td>
                                    <td>{{ stat.referrer ? stat.referrer|slice(0, 40) : '-' }}</td>
                                    <td>{{ stat.lastHit|date('short') }}</td>
                                    <td>{{ stat.lastHit|time('short') }}</td>
                                    <td>
                                        <a href="{{ url('redirect-manager/redirects/new', { sourceUrl: stat.url }) }}"
                                           class="btn submit icon add"
                                           title="{{ 'Create redirect'|t('redirect-manager') }}"></a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="6" class="thin light">{{ "No unhandled 404s! Great job!"|t('redirect-manager') }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% include 'redirect-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% css %}
    #analytics-dashboard {
        padding: 24px;
    }

    .analytics-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-box {
        background: #f3f7fc;
        padding: 24px;
        border-radius: 4px;
        text-align: center;
        border: 1px solid var(--border-hairline);
    }

    .stat-value {
        font-size: 32px;
        font-weight: 600;
        color: #0d78f2;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: #596673;
    }

    .analytics-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }

    .analytics-charts.two-columns {
        grid-template-columns: repeat(2, 1fr);
    }

    @media (max-width: 1024px) {
        .analytics-charts.two-columns {
            grid-template-columns: 1fr;
        }
    }

    .chart-container.full-width {
        grid-column: 1 / -1;
    }

    .chart-container h3 {
        margin: 0 0 20px;
        font-size: 16px;
    }

    .chart-container {
        background: #fff;
        border: 1px solid #e3e5e8;
        border-radius: 4px;
        padding: 24px;
        min-width: 0; /* Allow flex/grid item to shrink below content size */
        overflow: hidden; /* Prevent content from pushing out */
    }

    .chart-container canvas {
        max-height: 300px;
        max-width: 100%;
    }

    /* Ensure chart wrapper respects container size */
    .chart-container > canvas {
        display: block;
        box-sizing: border-box;
    }

    .table-scroll-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -24px;
        padding: 0 24px;
    }

    .table-scroll-container table {
        min-width: 100%;
        width: 100%;
    }
{% endcss %}

{% js %}
    // Store chart instances globally
    window.analyticsCharts = window.analyticsCharts || {};

    // Load Chart.js if not already loaded
    if (typeof Chart === 'undefined') {
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
        script.onload = initCharts;
        document.head.appendChild(script);
    } else {
        initCharts();
    }

    // Date range change handler
    $(document).ready(function() {
        let currentDateRange = '{{ dateRange }}';

        // Handle date range selection via AJAX
        $(document).on('click', '.main-date-range-option', function(e) {
            e.preventDefault();

            const $btn = $(this);
            const range = $btn.data('range');

            // Update the button text
            const rangeLabels = {
                'today': '{{ "Today"|t('redirect-manager')|e('js') }}',
                'yesterday': '{{ "Yesterday"|t('redirect-manager')|e('js') }}',
                'last7days': '{{ "Last 7 days"|t('redirect-manager')|e('js') }}',
                'last30days': '{{ "Last 30 days"|t('redirect-manager')|e('js') }}',
                'last90days': '{{ "Last 90 days"|t('redirect-manager')|e('js') }}',
                'all': '{{ "All time"|t('redirect-manager')|e('js') }}'
            };

            // Update button text immediately
            $('#dateRangeLabel').text(rangeLabels[range] || range);

            // Update selected state
            $btn.closest('ul').find('.sel').removeClass('sel');
            $btn.addClass('sel');

            // Close the menu
            $btn.closest('.menu').removeClass('active');
            $btn.closest('.btngroup').find('.menubtn').removeClass('active');

            // Update current range
            currentDateRange = range;

            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('dateRange', range);
            window.history.pushState({}, '', url);

            // Show loading state
            $('#analytics-dashboard').css('opacity', '0.5');

            // Reload the page data via AJAX
            loadAnalyticsData(range);
        });

        // Handle export link clicks
        $(document).on('click', '.export-link', function(e) {
            e.preventDefault();
            const $link = $(this);
            const action = $link.data('action');
            const format = $link.data('format') || 'csv';

            // Build URL with current date range
            const exportUrl = Craft.getActionUrl(action, {
                dateRange: currentDateRange,
                format: format
            });

            // Trigger download
            window.location.href = exportUrl;
        });

        // Load analytics data
        function loadAnalyticsData(dateRange) {
            // Update summary stats and tables
            $.ajax({
                url: '{{ actionUrl('redirect-manager/analytics/get-data')|raw }}',
                type: 'POST',
                dataType: 'json',
                data: {
                    dateRange: dateRange,
                    type: 'summary',
                    {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
                },
                success: function(response) {
                    if (response.success && response.data) {
                        // Update stat boxes with number formatting
                        $('#total-404s').text((response.data.totalCount || 0).toLocaleString());
                        $('#handled-404s').text((response.data.handledCount || 0).toLocaleString());
                        $('#unhandled-404s').text((response.data.unhandledCount || 0).toLocaleString());

                        // Update success rate
                        const total = response.data.totalCount || 0;
                        const handled = response.data.handledCount || 0;
                        const rate = total > 0 ? Math.round((handled / total) * 100) : 0;
                        $('#success-rate').text(rate + '%');

                        // Update tables
                        updateMostCommonTable(response.data.mostCommon || []);
                        updateRecentUnhandledTable(response.data.recentUnhandled || []);

                        // Update top bots table if available
                        updateTopBotsTable(response.data.topBots || []);
                    }

                    // Restore opacity
                    $('#analytics-dashboard').css('opacity', '1');

                    // Re-initialize charts with new data
                    initCharts();
                },
                error: function() {
                    $('#analytics-dashboard').css('opacity', '1');
                    Craft.cp.displayError('{{ "Failed to load analytics data"|t('redirect-manager')|e('js') }}');
                }
            });
        }

        // Update most common table
        function updateMostCommonTable(mostCommon) {
            let html = '';
            if (mostCommon.length === 0) {
                html = '<tr><td colspan="5" class="thin light">{{ "No 404s recorded yet"|t('redirect-manager')|e('js') }}</td></tr>';
            } else {
                mostCommon.forEach(function(stat) {
                    html += '<tr>';
                    html += '<td><a class="label-link" href="' + Craft.escapeHtml(stat.url) + '" target="_blank"><span><code>' + Craft.escapeHtml(stat.url.substring(0, 80)) + '</code></span></a></td>';
                    html += '<td><strong>' + (stat.count || 0).toLocaleString() + '</strong></td>';
                    html += '<td>' + (stat.handled ? '<span class="status green"></span>' : '<span class="status red"></span>') + '</td>';
                    if (stat.lastHitFormatted) {
                        const parts = stat.lastHitFormatted.split(', ');
                        html += '<td>' + (parts[0] || '') + '</td>';
                        html += '<td>' + (parts[1] || '') + '</td>';
                    } else {
                        const date = new Date(stat.lastHit.date || stat.lastHit);
                        html += '<td>' + Craft.formatDate(date, 'short') + '</td>';
                        html += '<td>' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) + '</td>';
                    }
                    html += '</tr>';
                });
            }
            $('h2:contains("Most Common 404s (Top 15)")').next('.analytics-charts').find('tbody').html(html);
        }

        // Update recent unhandled table
        function updateRecentUnhandledTable(recentUnhandled) {
            let html = '';
            if (recentUnhandled.length === 0) {
                html = '<tr><td colspan="6" class="thin light">{{ "No unhandled 404s! Great job!"|t('redirect-manager')|e('js') }}</td></tr>';
            } else {
                recentUnhandled.forEach(function(stat) {
                    html += '<tr>';
                    html += '<td><a class="label-link" href="' + Craft.escapeHtml(stat.url) + '" target="_blank"><span><code>' + Craft.escapeHtml(stat.url.substring(0, 80)) + '</code></span></a></td>';
                    html += '<td>' + (stat.count || 0).toLocaleString() + '</td>';
                    html += '<td>' + (stat.referrer ? Craft.escapeHtml(stat.referrer.substring(0, 40)) : '-') + '</td>';
                    if (stat.lastHitFormatted) {
                        const parts = stat.lastHitFormatted.split(', ');
                        html += '<td>' + (parts[0] || '') + '</td>';
                        html += '<td>' + (parts[1] || '') + '</td>';
                    } else {
                        const date = new Date(stat.lastHit.date || stat.lastHit);
                        html += '<td>' + Craft.formatDate(date, 'short') + '</td>';
                        html += '<td>' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) + '</td>';
                    }
                    html += '<td><a href="' + Craft.getUrl('redirect-manager/redirects/new', { sourceUrl: stat.url }) + '" class="btn submit icon add" title="{{ "Create redirect"|t('redirect-manager')|e('js') }}"></a></td>';
                    html += '</tr>';
                });
            }
            $('h2:contains("Recent Unhandled 404s")').next('.analytics-charts').find('tbody').html(html);
        }

        // Update top bots table
        function updateTopBotsTable(topBots) {
            let html = '';
            if (topBots.length === 0) {
                html = '<tr><td colspan="2" style="text-align: center; color: #999;">{{ "No bot data available"|t('redirect-manager')|e('js') }}</td></tr>';
            } else {
                topBots.forEach(function(bot) {
                    html += '<tr>';
                    html += '<td>' + Craft.escapeHtml(bot.botName) + '</td>';
                    html += '<td>' + (bot.count || 0).toLocaleString() + '</td>';
                    html += '</tr>';
                });
            }
            $('h3:contains("Top Bots")').next('.table-scroll-container').find('tbody').html(html);
        }
    });

    function initCharts() {
        // Destroy existing charts
        if (window.analyticsCharts) {
            Object.keys(window.analyticsCharts).forEach(function(key) {
                if (window.analyticsCharts[key] && typeof window.analyticsCharts[key].destroy === 'function') {
                    window.analyticsCharts[key].destroy();
                }
            });
            window.analyticsCharts = {};
        }

        // Get current date range
        const urlParams = new URLSearchParams(window.location.search);
        const currentRange = urlParams.get('dateRange') || '{{ dateRange }}';

        // Chart colors
        const chartColors = [
            '#0d78f2', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c',
            '#34495e', '#e67e22', '#3498db', '#2ecc71', '#c0392b', '#f1c40f'
        ];

        // Load 404 trend chart data via AJAX
        $.ajax({
            url: '{{ actionUrl('redirect-manager/analytics/get-data')|raw }}',
            type: 'POST',
            dataType: 'json',
            data: {
                dateRange: currentRange,
                type: 'chart',
                {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
            },
            success: function(response) {
                if (response.success && response.data && response.data.length > 0) {
                    const chartData = response.data;
                    // 404 Trend Chart
                    window.analyticsCharts.trendChart = new Chart(document.getElementById('404-trend-chart'), {
                        type: 'line',
                        data: {
                            labels: chartData.map(d => d.date),
                            datasets: [
                                {
                                    label: '{{ "Handled"|t('redirect-manager') }}',
                                    data: chartData.map(d => d.handled),
                                    borderColor: '#10B981',
                                    backgroundColor: '#10B981',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: '{{ "Unhandled"|t('redirect-manager') }}',
                                    data: chartData.map(d => d.unhandled),
                                    borderColor: '#EF4444',
                                    backgroundColor: '#EF4444',
                                    tension: 0.1,
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        precision: 0
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    align: 'center',
                                    labels: {
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        padding: 20
                                    }
                                }
                            }
                        }
                    });
                }
            }
        });

        // Bot vs Human Traffic Chart via AJAX
        $.ajax({
            url: '{{ actionUrl('redirect-manager/analytics/get-data')|raw }}',
            type: 'POST',
            dataType: 'json',
            data: {
                dateRange: currentRange,
                type: 'bots',
                {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
            },
            success: function(response) {
                if (response.success && response.data && response.data.chart) {
                    window.analyticsCharts.botChart = new Chart(document.getElementById('bot-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: response.data.chart.labels,
                            datasets: [{
                                data: response.data.chart.values,
                                backgroundColor: [chartColors[1], chartColors[2]]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    // Update bot percentage text
                    $('.analytics-charts.two-columns .chart-container div[style*="text-align"]').html(
                        '<strong>' + response.data.botPercentage + '%</strong> of traffic is from bots'
                    );
                }
            }
        });

        // Device Types Chart via AJAX
        $.ajax({
            url: '{{ actionUrl('redirect-manager/analytics/get-data')|raw }}',
            type: 'POST',
            dataType: 'json',
            data: {
                dateRange: currentRange,
                type: 'devices',
                {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
            },
            success: function(response) {
                if (response.success && response.data && response.data.labels && response.data.labels.length > 0) {
                    window.analyticsCharts.deviceChart = new Chart(document.getElementById('device-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: response.data.labels,
                            datasets: [{
                                data: response.data.values,
                                backgroundColor: chartColors.slice(0, response.data.labels.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }
        });

        // Browser Usage Chart via AJAX
        $.ajax({
            url: '{{ actionUrl('redirect-manager/analytics/get-data')|raw }}',
            type: 'POST',
            dataType: 'json',
            data: {
                dateRange: currentRange,
                type: 'browsers',
                {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
            },
            success: function(response) {
                if (response.success && response.data && response.data.labels && response.data.labels.length > 0) {
                    const browserCtx = document.getElementById('browser-chart');
                    if (browserCtx) {
                        browserCtx.parentElement.style.minHeight = '300px';
                    }
                    window.analyticsCharts.browserChart = new Chart(browserCtx, {
                        type: 'bar',
                        data: {
                            labels: response.data.labels,
                            datasets: [{
                                label: '{{ "404s"|t('redirect-manager') }}',
                                data: response.data.values,
                                backgroundColor: chartColors[0],
                                borderColor: chartColors[0],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        precision: 0
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            }
        });

        // Operating Systems Chart via AJAX
        $.ajax({
            url: '{{ actionUrl('redirect-manager/analytics/get-data')|raw }}',
            type: 'POST',
            dataType: 'json',
            data: {
                dateRange: currentRange,
                type: 'os',
                {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
            },
            success: function(response) {
                if (response.success && response.data && response.data.labels && response.data.labels.length > 0) {
                    window.analyticsCharts.osChart = new Chart(document.getElementById('os-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: response.data.labels,
                            datasets: [{
                                data: response.data.values,
                                backgroundColor: chartColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }
        });
    }
{% endjs %}
