{% extends "_layouts/cp" %}
{% set title = "Analytics"|t('redirect-manager') %}
{% set selectedSubnavItem = 'analytics' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set settings = plugin.settings %}
{% set crumbs = [
    {
        label: redirectHelper.fullName|t('redirect-manager'),
        url: url('redirect-manager'),
    },
    {
        label: 'Analytics'|t('redirect-manager'),
        url: url('redirect-manager/analytics'),
    },
] %}

{# Define Tabs #}
{% set tabs = {
    overview: { label: "Overview"|t('redirect-manager'), url: '#overview' },
    'traffic-devices': { label: "Traffic & Devices"|t('redirect-manager'), url: '#traffic-devices' }
} %}

{# Only add Geographic tab if geo detection is enabled #}
{% if settings.enableGeoDetection %}
    {% set tabs = tabs|merge({
        geographic: { label: "Geographic"|t('redirect-manager'), url: '#geographic' }
    }) %}
{% endif %}

{% set selectedTab = 'overview' %}

{% block actionButton %}
    <div id="action-button" class="btngroup">
        <button type="button" class="btn menubtn" data-icon="download">{{ "Export"|t('redirect-manager') }}</button>
        <div class="menu" data-align="right">
            <ul>
                <li>
                    <a href="#" class="export-link" data-format="csv" data-action="redirect-manager/analytics/export-csv">{{ "Export as CSV"|t('redirect-manager') }}</a>
                </li>
                <li>
                    <a href="#" class="export-link" data-format="json" data-action="redirect-manager/analytics/export-csv">{{ "Export as JSON"|t('redirect-manager') }}</a>
                </li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block toolbar %}
    <div class="flex">
        {% if sites|length > 1 %}
        <div>
            <div class="btngroup">
                <button type="button" class="btn menubtn">
                    <span id="siteLabel">{{ siteId ? sites|filter(s => s.id == siteId)|first.name : 'All Sites'|t('redirect-manager') }}</span>
                </button>
                <div class="menu">
                    <ul>
                        <li><a href="#" data-site="" class="site-option {{ not siteId ? 'sel' : '' }}">{{ "All Sites"|t('redirect-manager') }}</a></li>
                        {% for site in sites %}
                            <li><a href="#" data-site="{{ site.id }}" class="site-option {{ siteId == site.id ? 'sel' : '' }}">{{ site.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        <div>
            <div class="btngroup">
                <button type="button" class="btn menubtn">
                    <span id="dateRangeLabel">{{ dateRange == 'today' ? 'Today' : (dateRange == 'yesterday' ? 'Yesterday' : (dateRange == 'last7days' ? 'Last 7 days' : (dateRange == 'last30days' ? 'Last 30 days' : (dateRange == 'last90days' ? 'Last 90 days' : 'All time')))) }}</span>
                </button>
                <div class="menu">
                    <ul>
                        <li><a href="#" data-range="today" class="main-date-range-option {{ dateRange == 'today' ? 'sel' : '' }}">{{ "Today"|t('redirect-manager') }}</a></li>
                        <li><a href="#" data-range="yesterday" class="main-date-range-option {{ dateRange == 'yesterday' ? 'sel' : '' }}">{{ "Yesterday"|t('redirect-manager') }}</a></li>
                        <li><a href="#" data-range="last7days" class="main-date-range-option {{ dateRange == 'last7days' ? 'sel' : '' }}">{{ "Last 7 days"|t('redirect-manager') }}</a></li>
                        <li><a href="#" data-range="last30days" class="main-date-range-option {{ dateRange == 'last30days' ? 'sel' : '' }}">{{ "Last 30 days"|t('redirect-manager') }}</a></li>
                        <li><a href="#" data-range="last90days" class="main-date-range-option {{ dateRange == 'last90days' ? 'sel' : '' }}">{{ "Last 90 days"|t('redirect-manager') }}</a></li>
                        <li><a href="#" data-range="all" class="main-date-range-option {{ dateRange == 'all' ? 'sel' : '' }}">{{ "All time"|t('redirect-manager') }}</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    {# Tab Content - IDs must match tab URLs #}
    <div id="overview" class="tab-content">
        {% include 'redirect-manager/analytics/_tabs/overview' %}
    </div>

    <div id="traffic-devices" class="tab-content hidden">
        {% include 'redirect-manager/analytics/_tabs/traffic-devices' %}
    </div>

    {% if settings.enableGeoDetection %}
    <div id="geographic" class="tab-content hidden">
        {% include 'redirect-manager/analytics/_tabs/geographic' %}
    </div>
    {% endif %}

    {% include 'redirect-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% css %}
    /* Tab content padding */
    .tab-content {
        padding: 24px;
    }

    .analytics-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-box {
        background: #f3f7fc;
        padding: 24px;
        border-radius: 4px;
        text-align: center;
        border: 1px solid var(--border-hairline);
    }

    .stat-value {
        font-size: 32px;
        font-weight: 600;
        color: #0d78f2;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: #596673;
    }

    .analytics-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }

    .analytics-charts.two-columns {
        grid-template-columns: repeat(2, 1fr);
    }

    @media (max-width: 1024px) {
        .analytics-charts.two-columns {
            grid-template-columns: 1fr;
        }
    }

    .chart-container.full-width {
        grid-column: 1 / -1;
    }

    .chart-container h3 {
        margin: 0 0 20px;
        font-size: 16px;
    }

    .chart-container {
        background: #fff;
        border: 1px solid #e3e5e8;
        border-radius: 4px;
        padding: 24px;
        min-width: 0;
        overflow: hidden;
    }

    .chart-container canvas {
        max-height: 300px;
        max-width: 100%;
    }

    .chart-container > canvas {
        display: block;
        box-sizing: border-box;
    }

    .table-scroll-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -24px;
        padding: 0 24px;
    }

    .table-scroll-container table {
        min-width: 100%;
        width: 100%;
    }
{% endcss %}

{% js %}
    // Global Chart Instances
    window.rmCharts = {};
    window.currentTab = 'overview';

    // Load Chart.js
    if (typeof Chart === 'undefined') {
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
        script.onload = function() { initCharts(); };
        document.head.appendChild(script);
    } else {
        initCharts();
    }

    // Chart colors
    const chartColors = [
        '#0d78f2', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c',
        '#34495e', '#e67e22', '#3498db', '#2ecc71', '#c0392b', '#f1c40f'
    ];

    // Initialize all charts
    function initCharts() {
        // Destroy existing charts
        Object.values(window.rmCharts).forEach(c => { if (c && c.destroy) c.destroy(); });
        window.rmCharts = {};

        // Get current parameters
        const urlParams = new URLSearchParams(window.location.search);
        const currentRange = urlParams.get('dateRange') || '{{ dateRange }}';
        const currentSite = urlParams.get('siteId') || '';

        // Load all chart data via AJAX
        loadChartData(currentRange, currentSite);
    }

    // Load chart data for all tabs
    function loadChartData(dateRange, siteId) {
        const csrfToken = '{{ craft.app.request.csrfToken }}';
        const csrfName = '{{ craft.app.config.general.csrfTokenName }}';

        // Load trend chart
        $.ajax({
            url: Craft.getActionUrl('redirect-manager/analytics/get-data'),
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'chart', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success && response.data && response.data.length > 0) {
                    renderTrendChart(response.data);
                }
            }
        });

        // Load bot stats
        $.ajax({
            url: Craft.getActionUrl('redirect-manager/analytics/get-data'),
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'bots', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success && response.data) {
                    renderBotChart(response.data);
                }
            }
        });

        // Load device breakdown
        $.ajax({
            url: Craft.getActionUrl('redirect-manager/analytics/get-data'),
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'devices', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success && response.data && response.data.labels && response.data.labels.length > 0) {
                    renderDeviceChart(response.data);
                }
            }
        });

        // Load browser breakdown
        $.ajax({
            url: Craft.getActionUrl('redirect-manager/analytics/get-data'),
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'browsers', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success && response.data && response.data.labels && response.data.labels.length > 0) {
                    renderBrowserChart(response.data);
                }
            }
        });

        // Load OS breakdown
        $.ajax({
            url: Craft.getActionUrl('redirect-manager/analytics/get-data'),
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'os', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success && response.data && response.data.labels && response.data.labels.length > 0) {
                    renderOsChart(response.data);
                }
            }
        });
    }

    // Chart rendering functions
    function renderTrendChart(data) {
        const ctx = document.getElementById('404-trend-chart');
        if (!ctx) return;

        if (window.rmCharts.trend) window.rmCharts.trend.destroy();

        window.rmCharts.trend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [
                    { label: '{{ "Handled"|t('redirect-manager') }}', data: data.map(d => d.handled), borderColor: '#10B981', backgroundColor: '#10B981', tension: 0.1, fill: false },
                    { label: '{{ "Unhandled"|t('redirect-manager') }}', data: data.map(d => d.unhandled), borderColor: '#EF4444', backgroundColor: '#EF4444', tension: 0.1, fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
                plugins: { legend: { position: 'bottom', align: 'center', labels: { usePointStyle: true, pointStyle: 'circle', padding: 20 } } }
            }
        });
    }

    function renderBotChart(data) {
        const ctx = document.getElementById('bot-chart');
        if (!ctx || !data.chart) return;

        if (window.rmCharts.bot) window.rmCharts.bot.destroy();

        window.rmCharts.bot = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.chart.labels,
                datasets: [{ data: data.chart.values, backgroundColor: [chartColors[1], chartColors[2]] }]
            },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' } } }
        });

        // Update percentage text
        $('#bot-percentage-text').html('<strong>' + data.botPercentage + '%</strong> {{ "of traffic is from bots"|t('redirect-manager') }}');
    }

    function renderDeviceChart(data) {
        const ctx = document.getElementById('device-chart');
        if (!ctx) return;

        if (window.rmCharts.device) window.rmCharts.device.destroy();

        window.rmCharts.device = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{ data: data.values, backgroundColor: chartColors.slice(0, data.labels.length) }]
            },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderBrowserChart(data) {
        const ctx = document.getElementById('browser-chart');
        if (!ctx) return;

        if (window.rmCharts.browser) window.rmCharts.browser.destroy();
        ctx.parentElement.style.minHeight = '300px';

        window.rmCharts.browser = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{ label: '{{ "404s"|t('redirect-manager') }}', data: data.values, backgroundColor: chartColors[0], borderColor: chartColors[0], borderWidth: 1 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    function renderOsChart(data) {
        const ctx = document.getElementById('os-chart');
        if (!ctx) return;

        if (window.rmCharts.os) window.rmCharts.os.destroy();

        window.rmCharts.os = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{ data: data.values, backgroundColor: chartColors }]
            },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' } } }
        });
    }

    // Tab Switching
    function switchTab(tabId) {
        if (!tabId) tabId = 'overview';

        // Hide all tab content
        $('.tab-content').addClass('hidden');
        // Show selected tab content
        $('#' + tabId).removeClass('hidden');

        window.currentTab = tabId;
    }

    // Handle hash changes (when Craft switches tabs)
    window.addEventListener('hashchange', function() {
        var hash = window.location.hash.substring(1);
        switchTab(hash);
    });

    // Document ready
    $(document).ready(function() {
        // Handle clicks on tab links
        $(document).on('click', 'a[href^="#"]', function() {
            var href = $(this).attr('href');
            if (href && href.startsWith('#')) {
                setTimeout(function() {
                    var hash = window.location.hash.substring(1);
                    switchTab(hash);
                }, 10);
            }
        });

        // Handle initial tab
        var hash = window.location.hash.substring(1) || 'overview';
        switchTab(hash);

        // Date Range Handler - reload page
        $(document).on('click', '.main-date-range-option', function(e) {
            e.preventDefault();
            const range = $(this).data('range');
            const url = new URL(window.location);
            url.searchParams.set('dateRange', range);
            window.location = url;
        });

        // Site Filter Handler - reload page
        $(document).on('click', '.site-option', function(e) {
            e.preventDefault();
            const siteId = $(this).data('site');
            const url = new URL(window.location);
            if (siteId) {
                url.searchParams.set('siteId', siteId);
            } else {
                url.searchParams.delete('siteId');
            }
            window.location = url;
        });

        // Export Handler
        $(document).on('click', '.export-link', function(e) {
            e.preventDefault();
            const action = $(this).data('action');
            const format = $(this).data('format') || 'csv';
            const dateRange = new URLSearchParams(window.location.search).get('dateRange') || 'last30days';
            const siteId = new URLSearchParams(window.location.search).get('siteId') || '';

            const exportUrl = Craft.getActionUrl(action, {
                dateRange: dateRange,
                siteId: siteId,
                format: format
            });

            window.location.href = exportUrl;
        });
    });
{% endjs %}
