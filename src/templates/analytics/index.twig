{% extends "_layouts/cp" %}
{% set title = "Analytics"|t('redirect-manager') %}
{% set selectedSubnavItem = 'statistics' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set crumbs = [
    {
        label: plugin.settings.pluginName|t('redirect-manager'),
        url: url('redirect-manager'),
    },
    {
        label: 'Analytics'|t('redirect-manager'),
        url: url('redirect-manager/analytics'),
    },
] %}

{% block content %}
    <div id="analytics-dashboard">
        <div class="analytics-stats">
            <div class="stat-box">
                <div class="stat-value" id="total-404s">{{ totalCount ?? 0 }}</div>
                <div class="stat-label">{{ "Total 404s"|t('redirect-manager') }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="handled-404s">{{ handledCount ?? 0 }}</div>
                <div class="stat-label">{{ "Handled"|t('redirect-manager') }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="unhandled-404s">{{ unhandledCount ?? 0 }}</div>
                <div class="stat-label">{{ "Unhandled"|t('redirect-manager') }}</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="success-rate">{{ totalCount > 0 ? ((handledCount / totalCount * 100)|round) : 0 }}%</div>
                <div class="stat-label">{{ "Success Rate"|t('redirect-manager') }}</div>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "404 Trend (Last 30 Days)"|t('redirect-manager') }}</h2>

        <div class="analytics-charts">
            <div class="chart-container full-width">
                <canvas id="404-trend-chart"></canvas>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Most Common 404s"|t('redirect-manager') }}</h2>

        <div class="analytics-charts">
            <div class="chart-container full-width">
                <div class="table-scroll-container">
                    <table class="data fullwidth">
                        <thead>
                            <tr>
                                <th>{{ 'URL'|t('redirect-manager') }}</th>
                                <th>{{ 'Count'|t('redirect-manager') }}</th>
                                <th>{{ 'Handled'|t('redirect-manager') }}</th>
                                <th>{{ 'Last Hit'|t('redirect-manager') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in mostCommon %}
                                <tr>
                                    <td>
                                        <a class="label-link" href="{{ stat.url }}" target="_blank">
                                            <span><code>{{ stat.url|slice(0, 80) }}</code></span>
                                        </a>
                                    </td>
                                    <td><strong>{{ stat.count }}</strong></td>
                                    <td>
                                        {% if stat.handled %}
                                            <span class="status green"></span>
                                        {% else %}
                                            <span class="status red"></span>
                                        {% endif %}
                                    </td>
                                    <td>{{ stat.lastHit|date('Y-m-d H:i:s') }}</td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="4" class="thin light">{{ "No 404s recorded yet"|t('redirect-manager') }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Traffic Analysis"|t('redirect-manager') }}</h2>

        <div class="analytics-charts two-columns">
            <div class="chart-container">
                <h3>{{ "Bot vs Human Traffic"|t('redirect-manager') }}</h3>
                <canvas id="bot-chart"></canvas>
                <div style="text-align: center; margin-top: 10px; color: #666;">
                    <strong>{{ botStats.botPercentage }}%</strong> of traffic is from bots
                </div>
            </div>

            <div class="chart-container">
                <h3>{{ "Top Bots"|t('redirect-manager') }}</h3>
                <div class="table-scroll-container">
                    <table class="data fullwidth">
                        <thead>
                            <tr>
                                <th>{{ "Bot Name"|t('redirect-manager') }}</th>
                                <th>{{ "404s"|t('redirect-manager') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if botStats.topBots|length > 0 %}
                                {% for bot in botStats.topBots %}
                                    <tr>
                                        <td>{{ bot.botName }}</td>
                                        <td>{{ bot.count }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="2" style="text-align: center; color: #999;">
                                        {{ "No bot data available"|t('redirect-manager') }}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Device Analytics"|t('redirect-manager') }}</h2>

        <div class="analytics-charts two-columns">
            <div class="chart-container">
                <h3>{{ "Device Types"|t('redirect-manager') }}</h3>
                <canvas id="device-chart"></canvas>
            </div>

            <div class="chart-container">
                <h3>{{ "Browser Usage"|t('redirect-manager') }}</h3>
                <canvas id="browser-chart"></canvas>
            </div>
        </div>

        <div class="analytics-charts" style="margin-top: 30px;">
            <div class="chart-container">
                <h3>{{ "Operating Systems"|t('redirect-manager') }}</h3>
                <canvas id="os-chart"></canvas>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">{{ "Recent Unhandled 404s"|t('redirect-manager') }}</h2>

        <div class="analytics-charts">
            <div class="chart-container full-width">
                <div class="table-scroll-container">
                    <table class="data fullwidth">
                        <thead>
                            <tr>
                                <th>{{ 'URL'|t('redirect-manager') }}</th>
                                <th>{{ 'Count'|t('redirect-manager') }}</th>
                                <th>{{ 'Referrer'|t('redirect-manager') }}</th>
                                <th>{{ 'Last Hit'|t('redirect-manager') }}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in recentUnhandled %}
                                <tr>
                                    <td>
                                        <a class="label-link" href="{{ stat.url }}" target="_blank">
                                            <span><code>{{ stat.url|slice(0, 80) }}</code></span>
                                        </a>
                                    </td>
                                    <td>{{ stat.count }}</td>
                                    <td>{{ stat.referrer ? stat.referrer|slice(0, 40) : '-' }}</td>
                                    <td>{{ stat.lastHit|date('Y-m-d H:i:s') }}</td>
                                    <td>
                                        <a href="{{ url('redirect-manager/redirects/new', { sourceUrl: stat.url }) }}"
                                           class="btn submit icon add"
                                           title="{{ 'Create redirect'|t('redirect-manager') }}"></a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="thin light">{{ "No unhandled 404s! Great job!"|t('redirect-manager') }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% include 'redirect-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% css %}
    #analytics-dashboard {
        padding: 24px;
    }

    .analytics-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-box {
        background: #f3f7fc;
        padding: 24px;
        border-radius: 4px;
        text-align: center;
        border: 1px solid var(--border-hairline);
    }

    .stat-value {
        font-size: 32px;
        font-weight: 600;
        color: #0d78f2;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: #596673;
    }

    .analytics-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }

    .analytics-charts.two-columns {
        grid-template-columns: repeat(2, 1fr);
    }

    @media (max-width: 1024px) {
        .analytics-charts.two-columns {
            grid-template-columns: 1fr;
        }
    }

    .chart-container.full-width {
        grid-column: 1 / -1;
    }

    .chart-container h3 {
        margin: 0 0 20px;
        font-size: 16px;
    }

    .chart-container {
        background: #fff;
        border: 1px solid #e3e5e8;
        border-radius: 4px;
        padding: 24px;
        min-width: 0; /* Allow flex/grid item to shrink below content size */
        overflow: hidden; /* Prevent content from pushing out */
    }

    .chart-container canvas {
        max-height: 300px;
        max-width: 100%;
    }

    /* Ensure chart wrapper respects container size */
    .chart-container > canvas {
        display: block;
        box-sizing: border-box;
    }

    .table-scroll-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -24px;
        padding: 0 24px;
    }

    .table-scroll-container table {
        min-width: 100%;
        width: 100%;
    }
{% endcss %}

{% js %}
    // Load Chart.js if not already loaded
    if (typeof Chart === 'undefined') {
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
        script.onload = initCharts;
        document.head.appendChild(script);
    } else {
        initCharts();
    }

    function initCharts() {
        // Chart colors
        const chartColors = [
            '#0d78f2', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c',
            '#34495e', '#e67e22', '#3498db', '#2ecc71', '#c0392b', '#f1c40f'
        ];

        // Prepare chart data
        const chartData = {{ chartData|json_encode|raw }};

        if (chartData && chartData.length > 0) {
            // 404 Trend Chart
            new Chart(document.getElementById('404-trend-chart'), {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [
                        {
                            label: '{{ "Handled"|t('redirect-manager') }}',
                            data: chartData.map(d => d.handled),
                            borderColor: '#10B981',
                            backgroundColor: '#10B981',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '{{ "Unhandled"|t('redirect-manager') }}',
                            data: chartData.map(d => d.unhandled),
                            borderColor: '#EF4444',
                            backgroundColor: '#EF4444',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            align: 'center',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // Bot vs Human Traffic Chart
        const botStats = {{ botStats|json_encode|raw }};
        if (botStats && botStats.chart) {
            new Chart(document.getElementById('bot-chart'), {
                type: 'doughnut',
                data: {
                    labels: botStats.chart.labels,
                    datasets: [{
                        data: botStats.chart.values,
                        backgroundColor: [chartColors[1], chartColors[2]]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Device Types Chart
        const deviceData = {{ deviceBreakdown|json_encode|raw }};
        if (deviceData && deviceData.labels && deviceData.labels.length > 0) {
            new Chart(document.getElementById('device-chart'), {
                type: 'doughnut',
                data: {
                    labels: deviceData.labels,
                    datasets: [{
                        data: deviceData.values,
                        backgroundColor: chartColors.slice(0, deviceData.labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Browser Usage Chart
        const browserData = {{ browserBreakdown|json_encode|raw }};
        if (browserData && browserData.labels && browserData.labels.length > 0) {
            const browserCtx = document.getElementById('browser-chart');
            if (browserCtx) {
                browserCtx.parentElement.style.minHeight = '300px';
            }
            new Chart(browserCtx, {
                type: 'bar',
                data: {
                    labels: browserData.labels,
                    datasets: [{
                        label: '{{ "404s"|t('redirect-manager') }}',
                        data: browserData.values,
                        backgroundColor: chartColors[0],
                        borderColor: chartColors[0],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Operating Systems Chart
        const osData = {{ osBreakdown|json_encode|raw }};
        if (osData && osData.labels && osData.labels.length > 0) {
            new Chart(document.getElementById('os-chart'), {
                type: 'doughnut',
                data: {
                    labels: osData.labels,
                    datasets: [{
                        data: osData.values,
                        backgroundColor: chartColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    }
{% endjs %}
