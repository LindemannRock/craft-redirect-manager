{#
 # Analytics Page
 #
 # Uses the base plugin's cp-analytics layout for consistent styling.
 #}

{% extends 'lindemannrock-base/_layouts/cp-analytics' %}

{% set plugin = craft.app.plugins.getPlugin('redirect-manager') %}
{% set settings = plugin.settings %}

{# Define tabs - Geographic only if geo detection enabled #}
{% set tabsConfig = {
    overview: { label: "Overview"|t('redirect-manager') },
    'traffic-devices': { label: "Traffic & Devices"|t('redirect-manager') }
} %}

{% if settings.enableGeoDetection %}
    {% set tabsConfig = tabsConfig|merge({
        geographic: { label: "Geographic"|t('redirect-manager') }
    }) %}
{% endif %}

{% set analyticsConfig = {
    plugin: {
        handle: pluginHandle ?? 'redirect-manager',
        name: redirectHelper.fullName,
    },
    page: {
        title: 'Analytics'|t('redirect-manager'),
        subnav: 'analytics',
        crumbs: [
            { label: redirectHelper.fullName, url: url('redirect-manager') },
            { label: 'Analytics'|t('redirect-manager'), url: url('redirect-manager/analytics') },
        ],
    },
    tabs: tabsConfig,
    filters: {
        dateRange: {
            current: dateRange,
        },
        sites: {
            enabled: sites|length > 1,
            current: siteId,
            sites: sites,
        },
    },
    export: {
        permission: 'redirectManager:exportAnalytics',
        action: 'redirect-manager/analytics/export',
        extraParams: {siteId: siteId},
    },
    charts: {
        prefix: 'rm',
        dataEndpoint: 'redirect-manager/analytics/get-data',
    },
} %}

{% block tabs %}
    <div id="overview" class="lr-tab-content">
        {% include 'redirect-manager/analytics/_partials/overview' %}
    </div>

    <div id="traffic-devices" class="lr-tab-content hidden">
        {% include 'redirect-manager/analytics/_partials/traffic-devices' %}
    </div>

    {% if settings.enableGeoDetection %}
    <div id="geographic" class="lr-tab-content hidden">
        {% include 'redirect-manager/analytics/_partials/geographic' %}
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script data-analytics-reinit="true">
(function() {
    if (window.lrRedirectAnalyticsBound) {
        return;
    }
    window.lrRedirectAnalyticsBound = true;

document.addEventListener('lr:analyticsInit', function(e) {
    // Chart colors
    const chartColors = window.lrChartColors || [
        '#0d78f2', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c',
        '#34495e', '#e67e22', '#3498db', '#2ecc71', '#c0392b', '#f1c40f'
    ];

    const config = e.detail && e.detail.config ? e.detail.config : (window.lrAnalyticsConfig || {});
    const currentRange = config.dateRange || '{{ dateRange }}';
    const currentSite = config.siteId || '';

    // Load all chart data
    loadAllCharts(currentRange, currentSite);

    function destroyChart(canvasId) {
        const config = window.lrAnalyticsConfig || {};
        const prefix = config.prefix || 'analytics';
        const chartKey = canvasId.replace(/-/g, '_');
        if (window.lrChartInstances && window.lrChartInstances[prefix] && window.lrChartInstances[prefix][chartKey]) {
            window.lrChartInstances[prefix][chartKey].destroy();
            delete window.lrChartInstances[prefix][chartKey];
        }
    }

    function resetChartState(canvas) {
        if (!canvas) return;
        canvas.style.display = '';
        const parent = canvas.parentElement || canvas.parentNode;
        if (!parent) return;
        parent.querySelectorAll('.zilch').forEach(el => el.remove());
    }

    function loadAllCharts(dateRange, siteId) {
        const csrfToken = '{{ craft.app.request.csrfToken }}';
        const csrfName = '{{ craft.app.config.general.csrfTokenName }}';
        const endpoint = Craft.getActionUrl('redirect-manager/analytics/get-data');

        // Load trend chart
        $.ajax({
            url: endpoint,
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'chart', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success) {
                    renderTrendChart(response.data || []);
                }
            }
        });

        // Load bot stats
        $.ajax({
            url: endpoint,
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'bots', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success) {
                    renderBotChart(response.data || null);
                }
            }
        });

        // Load device breakdown
        $.ajax({
            url: endpoint,
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'devices', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success) {
                    renderDeviceChart(response.data || null);
                }
            }
        });

        // Load browser breakdown
        $.ajax({
            url: endpoint,
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'browsers', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success) {
                    renderBrowserChart(response.data || null);
                }
            }
        });

        // Load OS breakdown
        $.ajax({
            url: endpoint,
            type: 'POST',
            dataType: 'json',
            data: { dateRange: dateRange, siteId: siteId, type: 'os', [csrfName]: csrfToken },
            success: function(response) {
                if (response.success) {
                    renderOsChart(response.data || null);
                }
            }
        });
    }

    function renderTrendChart(data) {
        const ctx = document.getElementById('404-trend-chart');
        if (!ctx) return;
        resetChartState(ctx);
        if (!data || !data.length) {
            destroyChart('404-trend-chart');
            ctx.style.display = 'none';
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'zilch';
            emptyMsg.style.padding = '48px 24px';
            emptyMsg.innerHTML = '<p>{{ "No trend data available for the selected filters."|t('redirect-manager')|e('js') }}</p>';
            ctx.parentElement.appendChild(emptyMsg);
            return;
        }

        window.lrCreateChart('404-trend-chart', 'line', {
            labels: data.map(d => d.date),
            datasets: [
                { label: '{{ "Handled"|t('redirect-manager') }}', data: data.map(d => d.handled), borderColor: '#10B981', backgroundColor: '#10B981', tension: 0.1, fill: false },
                { label: '{{ "Unhandled"|t('redirect-manager') }}', data: data.map(d => d.unhandled), borderColor: '#EF4444', backgroundColor: '#EF4444', tension: 0.1, fill: false }
            ]
        }, {
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
            plugins: { legend: { position: 'bottom', align: 'center', labels: { usePointStyle: true, pointStyle: 'circle', padding: 20 } } }
        });
    }

    function renderBotChart(data) {
        const ctx = document.getElementById('bot-chart');
        if (!ctx) return;
        resetChartState(ctx);
        if (!data || !data.chart || !data.chart.labels || !data.chart.labels.length) {
            destroyChart('bot-chart');
            ctx.style.display = 'none';
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'zilch';
            emptyMsg.style.padding = '48px 24px';
            emptyMsg.innerHTML = '<p>{{ "No bot data available for the selected filters."|t('redirect-manager')|e('js') }}</p>';
            ctx.parentElement.appendChild(emptyMsg);
            return;
        }

        window.lrCreateChart('bot-chart', 'doughnut', {
            labels: data.chart.labels,
            datasets: [{ data: data.chart.values, backgroundColor: [chartColors[1], chartColors[2]] }]
        }, {
            plugins: { legend: { position: 'bottom' } }
        });

        // Update percentage text
        const botText = document.getElementById('bot-percentage-text');
        if (botText) {
            botText.innerHTML = '<strong>' + data.botPercentage + '%</strong> {{ "of traffic is from bots"|t('redirect-manager') }}';
        }
    }

    function renderDeviceChart(data) {
        const ctx = document.getElementById('device-chart');
        if (!ctx) return;
        resetChartState(ctx);
        if (!data || !data.labels || !data.labels.length) {
            destroyChart('device-chart');
            ctx.style.display = 'none';
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'zilch';
            emptyMsg.style.padding = '48px 24px';
            emptyMsg.innerHTML = '<p>{{ "No device data available for the selected filters."|t('redirect-manager')|e('js') }}</p>';
            ctx.parentElement.appendChild(emptyMsg);
            return;
        }
        window.lrCreateChart('device-chart', 'doughnut', {
            labels: data.labels,
            datasets: [{ data: data.values, backgroundColor: chartColors.slice(0, data.labels.length) }]
        }, {
            plugins: { legend: { position: 'bottom' } }
        });
    }

    function renderBrowserChart(data) {
        const ctx = document.getElementById('browser-chart');
        if (!ctx) return;
        resetChartState(ctx);
        if (!data || !data.labels || !data.labels.length) {
            destroyChart('browser-chart');
            ctx.style.display = 'none';
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'zilch';
            emptyMsg.style.padding = '48px 24px';
            emptyMsg.innerHTML = '<p>{{ "No browser data available for the selected filters."|t('redirect-manager')|e('js') }}</p>';
            ctx.parentElement.appendChild(emptyMsg);
            return;
        }
        ctx.parentElement.style.minHeight = '300px';

        window.lrCreateChart('browser-chart', 'bar', {
            labels: data.labels,
            datasets: [{ label: '{{ "404s"|t('redirect-manager') }}', data: data.values, backgroundColor: chartColors[0], borderColor: chartColors[0], borderWidth: 1 }]
        }, {
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
            plugins: { legend: { display: false } }
        });
    }

    function renderOsChart(data) {
        const ctx = document.getElementById('os-chart');
        if (!ctx) return;
        resetChartState(ctx);
        if (!data || !data.labels || !data.labels.length) {
            destroyChart('os-chart');
            ctx.style.display = 'none';
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'zilch';
            emptyMsg.style.padding = '48px 24px';
            emptyMsg.innerHTML = '<p>{{ "No OS data available for the selected filters."|t('redirect-manager')|e('js') }}</p>';
            ctx.parentElement.appendChild(emptyMsg);
            return;
        }
        window.lrCreateChart('os-chart', 'doughnut', {
            labels: data.labels,
            datasets: [{ data: data.values, backgroundColor: chartColors }]
        }, {
            plugins: { legend: { position: 'bottom' } }
        });
    }
});
})();
</script>
{% endblock %}
